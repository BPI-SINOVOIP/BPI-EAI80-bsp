
//#include <math.h>
#include <errno.h>
#include "ObjDetectorC.h"
#include <string.h>
//#include <gl_mgr.h>
#include <stdlib.h>
//#include <kuart.h>
#include <stdio.h>

#if 0
#define KUART_Output(a) \
    do \
    {  \
        printf(a); \
        printf("\n"); \
    }while(0)
#else
#define KUART_Output(...)
#endif


typedef struct _stripRange
{
    ifcvFeature *feature;
    int start;
    int end;
    float32_t sFactor;
    uint32_t processingRectSizeWidth;
    uint32_t sumStride;
    int stepSize;
    uint32_t windowSizeWidth, windowSizeHeight;

} Range;

//static void *buffer_2 = NULL;
icvRect *candidateResult = NULL;
uint32_t nCandidate;
cvFacedetectResult *pre_result = NULL;

const uint32_t nStageWeekClassifierCount_[FACE_MODEL_N_STAGES] = {5, 8, 10, 13, 16, 20, 21, 25, 31, 40, 47, 53, 63, 92};
const uint8_t  featureRectW[FACE_MODEL_N_FEATURE] = {4, 3, 3, 2, 3, 4, 4, 2, 3, 3, 2, 5, 2, 4, 3, 3, 2, 3, 2, 2, 5, 2, 4, 4, 3, 3, 2, 2, 4, 2, 2, 1, 2, 2, 1, 1, 1, 2, 4, 2, 2, 2, 2, 5, 2, 2, 2, 2, 1, 1, 5, 2, 3, 4, 1, 2, 2, 3, 1, 2, 4, 2, 6, 1, 2, 2, 4, 1, 1, 2, 2, 1, 4, 1, 2, 2, 3, 3, 2, 2, 4, 2, 2, 1, 1, 3, 1, 1, 2, 1, 2, 5, 1, 4, 2, 2, 2, 2, 3, 2, 3, 3, 2, 1, 3, 2, 1, 2, 2, 6, 2, 1, 2, 3, 2, 1, 3, 1, 2, 4, 2, 2, 2, 2, 1, 5, 2, 1, 6, 2, 1, 1, 5, 2, 1, 1, 1, 2, 1, 1, 2, 2, 1, 2, 2, 2, 1, 2, 2, 1, 3, 4, 2, 2, 3, 1, 1, 1, 5, 2, 2, 3, 1, 2, 1, 4, 1, 2, 1, 2, 1, 5, 1, 4, 1, 3, 1, 2, 2, 1, 2, 2, 1, 1, 6, 2, 3, 1, 2, 2, 1, 1, 2, 1, 1, 2, 2, 1, 2, 5, 1, 2, 6, 1, 5, 2, 1, 2, 1, 2, 1, 2, 1, 2, 3, 2, 3, 2, 1, 1, 1, 1, 1, 1, 2, 1, 2, 5, 1, 1, 2, 2, 1, 1, 1, 2, 4, 2, 2, 2, 2, 3, 3, 1, 2, 1, 2, 2, 1, 1, 4, 1, 2, 3, 2, 1, 1, 1, 5, 1, 6, 1, 1, 1, 1, 2, 1, 2, 2, 2, 1, 1, 3, 2, 1, 3, 2, 2, 1, 3, 1, 2, 1, 2, 1, 2, 1, 3, 2, 2, 3, 2, 3, 2, 2, 5, 3, 1, 2, 1, 5, 1, 1, 1, 1, 2, 1, 2, 2, 1, 3, 2, 1, 3, 1, 2, 2, 2, 1, 1, 2, 1, 1, 1, 2, 1, 2, 5, 2, 2, 1, 1, 1, 2, 1, 1, 3, 1, 1, 1, 2, 1, 1, 1, 2, 2, 1, 2, 2, 2, 2, 1, 2, 4, 2, 2, 2, 3, 1, 1, 1, 1, 2, 2, 1, 1, 2, 3, 1, 3, 1, 1, 2, 1, 1, 2, 2, 1, 3, 1, 1, 2, 2, 6, 3, 1, 1, 1, 1, 1, 2, 1, 5, 1, 1, 1, 1, 2, 2, 2, 1, 1, 1, 1, 1, 1, 5, 1, 1, 2, 2, 2, 4, 2, 1, 4, 1, 1, 1, 2, 2, 3, 1, 2, 1, 1, 1, 2, 1, 1, 5, 1, 3, 1, 1, 1, 1, 2, 3, 1, 2, 1, 1, 2};
const int32_t  cascadeInternalNodeValues_[FACE_MODEL_N_FEATURE * 8] =
{
    -1025, -5377, -67130693, -21829, -65, -1, -67130693, -21829, -18415934, -362615062, -19988737, -83886081, -145359024, -8912897, -11010049, -1, -858850112, -993207092, -556794555, -706740257, -704654336, -704643105, -193, -1, -285217118, -285479254, -4550, -896800086, -5248094, -65, -1058270, -357570046, -286265361, -286331138, -17825793, -285282561, -262145, 1207959551, -1, -1, -1, -4097, -21829, -21829, -65, -1, -21845, -21845, -16777534, -801050384, -257, -1, -12058793, -195756203, -1, -1, -856753152, -924778796, -545259563, -806354977, -134217776, -1, -9, -1, -21845, -4214997, -402677078, -12868950, -1883263041, -20545, -67138902, -4216145, -249, -129, -33, -1, -235, 2139094911, -201, -1, -269488129, -890311697, -1, -286328065, -1, 1191180287, -134219777, -1, -789515696, 1090109685, 61205, 1090454171, -185469072, -33554433, -1048581, -17441, -16781569, -16781569, -486880002, -525669650, -9147, -8388745, -84553664, -150995201, -1025, -4097, -21829, -21829, -65, -1, -21829, -21829, -1, -1, -1, -1, 805244927, -1, 268372815, 2147450879, -18416062, -17891602, -1114113, -4097, -8913068, -1, -1, -1, -225, -1, -1, -201326593, -235, 2139094911, -141, -1, -19923262, -1006306100, -552600240, -867172385, -721423120, -992479233, -77, -1, -16777486, -50593794, -16777286, -824185110, -4194310, -1, -83886558, -285217270, -286265345, -1360072705, -1, -285283073, -4194305, -805306369, -1, -1, 1614868592, -453705730, 1141182805, -4257, -214696013, -1, 927415091, -17473, -16781569, -16781569, -352653570, -521475346, -16792572, -210239625, -253305740, -227016705, 1878982655, 795782702, -65537, 799942190, 2147448831, 2147450751, 1879013119, 2147443839, -1, -4097, -21761, -21761, -65, -1, -21829, -21825, -1, 1069498287, -1, 724512687, -1, -1, -1, 801112063, -257, -257, -286342430, -487669014, -137, -129, -67122108, -14641, -1061093650, 1079311837, -69009409, -1, -791360316, -570425345, -134217809, -1, -233, -1, -1, -1, -33003, -8388737, -205, -1, -352345565, -8941769, -1594383821, -7425, -289427521, -21585, -67130437, -263173, -269488129, -1360089362, -268435457, -286347521, -1, 1207959551, -2049, -1, -5, -357630037, -16778320, -1432162390, -13, -822083585, -705171200, -4194381, -85004800, -856887381, -1474253824, -318970449, -145464316, -44712155, -178999804, -17, -178916096, -73011282, -570471307, -4945, 1968461685, -524289, -585769537, -68161537, 1122495231, 16018175, -285212673, -4613, 1179010175, 2147381119, -65537, -4371, -285217025, -1023488005, -352391442, -524357906, -134480009, 1719664511, -2097229, -1, -2009592676, -1996747532, 1073544703, -1667708452, -83459, -19136515, -1141047815, -1163358468, -1, -1, -1, -1, -1, -1, -1, -1050847, -285212673, -285278209, -1, -285216769, -1, -268435457, -1, -1, -21573, -21761, -201348421, -67130693, -17477, -1, -71325125, -21573, -433064960, -990969865, -286261483, -285212673, -134220013, -134742025, -4197581, -1, -134219981, 20182835, -2049, -134217729, 2004875191, 939524095, -2049, -1, -1, -84939026, -16843058, -534581750, -169, -8388737, -8397052, -150995385, -9131, -1, -16777217, -1, -33602556, 1434443549, -285476860, -1, -134217729, -808452145, 2010513367, -1060119345, -82051245, -582093049, -268306669, 1078452739, -67371009, -65, -1, -4193, 989537023, -1, 586350847, 1006568367, -77, -361758813, -171968752, -168558608, -73, -805306433, -135792735, -134219785, -179177995, 1962988832, -168176137, -173017665, 1426128383, -9179137, -1043335681, -2053, -1365069917, -290787670, -272961545, -823466462, -1880621193, -268976129, 2012706807, -1, -1810885392, -688126468, -1073758209, -58119, -1145258055, -81921, -1077952517, -1078261574, -196018700, -50539276, -65537, -254756, -46858256, -213515, -1073954887, -1413871560, -488447792, -353448740, 651100165, -269549489, -1565328461, -1075118081, 998191907, -17473, -16781569, -16781569, -85790982, -220004673, -142608553, -58724545, -152633634, -159383553, -1, -1, -1, -18, -1, -1, -18, -1048626, -1025, -4097, -21573, -1140872517, -65, -1, -21829, -67130437, -205, -268435457, -139, -1, -134219977, 2004352887, -134744204, -1, -176687808, -143130633

        , -10788, -1, 1431631220, -8912905, -781070082, -1, -791609345, 1440604127, -202113025, -142606337, 1079039477, -572522497, -235405313, -1, -286265361, -286330881, -1, -285217025, -1, 1342177279, -1, -1, -285236734, -2100302897, -420501982, -152572182, 1935622663, -2049, -201328862, -82, -353448370, -353374209, -287166721, -352383233, -143165612, -16777217, -589964, -4097, -252248848, -33565217, 1079048055, 1308574171, -7667781, -516, 992214011, 2145364650, -209, -1, -1, -218103809, -33007, 2139094911, -262345, -1, -84934962, -823202066, -269488305, -271585745, -1048828, 1145371534, -2097329, 1330642767, 4325598, 284168191, 721161983, 2012811007, 1987710719, -35690753, -135169, -53249, -77, -1976893533, -536874064, -1431634142, -67110989, -1916796961, -134744672, -704643085, -51405, -16809985, -4194305, -16385, -32911, -262273, -129, -32769, -437801031, -276844749, -138829511, -281827550, -1964004673, -1342177313, -1530953542, -271742036, -657400364, -50588420, -360449, -193795, -1087324240, -458835, -1078412359, -1078263624, 808456528, -50590500, -1, -1073799681, -1346846800, -1073991683, -1078018049, -1141174853, -25167137, -159383809, -419500294, -529862930, -285256635, -8915073, -151006140, -159908097, -268435534, 67174192, -521112560, -990840912, -301273414, 150836912, -59445665, -436208645, -389766656, -1347, -19021833, -201330825, -138412107, -4121, -134153, -1427234304, -1, -1, -17409, -21761, -1, -1, -21829, -21761, -67108865, -1, -1, -1, -1, -1, -1, -1431638289, 1963325184, -148783185, -3, -1, 1968570367, -524289, -2228225, -1, 1089725183, 838336511, -1543504897, -1140850689, 1089945855, -32769, -201331713, -1025, -249, -1, -1, -1, -235, 2139094911, -137, -1, -152913, -10490049, 1979032232, -46275926, 11472063, -2, 1079312554, -170409842, -537920048, -856883252, -928318464, -928448576, -134221344, -570427401, -709111424, -4456469, -1347768405, -1432178774, -32905, -1356722398, -805306369, 1181216767, -1, -1, -252379312, 1442796885, 1613823763, 1438593947, -1296, -35, -72613957, -17749, -17, -17891345, -286855442, -219746578, -129, -524289, -176696234, -134217729, -5243998, 33750786, -704909152, -243075152, -374341717, -1985216581, -742395520, -4194373, 1054064, -1661067299, -1073774593, 1073692671, -1074414147, -4210689, 1073692607, -1346696517, -286265593, -285218833, -4177, -823136529, -279447753, -286262617, -143165657, -286267648, -17830162, -6417, -487659778, -218181906, -733493937, -8435889, -185146114, -134227969, -1669317328, -17137671, -131075, -229379, -1124068464, -73793, -1079747331, -1931995684, -856369964, -51114500, -513, -61955, -1107313155, -16973827, -1410351105, -1342240577, -352326094, -144724572, -333386720, -454579209, -327881616, 1815367174, -463143307, -8912961, -61811468, -34339588, -8193, -259843, -1157761543, -197379, -1078214657, -1145370565, -33554686, -268435481, -33554656, 811794338, -67108980, -1964048497, -128, -251920453, -220725409, -253891516, -288428281, 14716416, -148504747, -185204747, -282854653, -134742153, 286987536, 1035943416, 1035958193, -33555460, 1062810805, -1147142151, 1035351953, -1074203251, -1, -4097, -17409, -21761, -65, -1, -17477, -21829, -1, 859043635, -65, 868218679, -1, -1073741825, -4097, -1140853765, -801046530, 1565908991, -72155137, -4456449, -792662804, -33554433, -77332497, -1, -268439553, -286326785, -1, -285212673, -1, 1342177279, -134219777, -1, -8716480, -9175042, -541073665, -2337, 1430279508, -76021761, 1598542941, -1, -2859, -1, -285212929, -1, -33569596, -33554433, -857863100, -318767105, -218110161, -201331713, -16781313, -201326593, 1953974143, 1988067327, -150994945, -201326593, -50, -553648129, -88, -117441538, -18, -855638017, -8, -251658241, -285219277, -1, -1002117552, -268435713, -16781313, -1093726518, -528385, -20849, -139460864, 83951360, -138414832, -1658323039, -1073741901, -1960313053, -1476398688, -1145045085, -1359040769, -1895911425, -1, -1359171841, -1073741825, -268435457, -1, -268443649, 325001731, 322139955, -260839365, -168305805, -1911910737,
        857159479, -76350549, -201851976, -16777473, -16781713, -16848130, 811780682, -537275, -10518665, -16791468, -193471402, 3150964, -34074627, -1073790977, -1073791489, -1078149195, -515, -1077985281, -1346437062, -285266125, -285278241, -268435457, -285212673, -16587, -5, -129, -1, -134220800, 16766037, -1365275128, 218103807, -73418360, -1426064385, -1431328120, -1427113217, -251726252, -118037266, -1970623729, -1996610358, -136841744, -2561, -1328321, -21521, -93, -282069069, -2576, -34603102, -268435525, -1901076497, -705203840, -570425357, -800000816, -36416260, -589825, -213251, -1078151180, -197127, -1073856515, -1145372549, -1068840756, -151593140, -65537, -117903412, -369381428, -8209, -21049400, -1460081460, -286333202, -16847122, -499724562, -227613969, 1179977280, -16822969, 1817660495, -47505, 1903554865, 832632611, -50335483, -1073742017, 1968535032, -1346502721, 2112829677, -1111624049, -285217041, -495980821, -486611930, -523833606, 2002470663, 8093503, 2147413782, -136316961, 1999504544, -1069393, -131137, 2142121898, 2130572721, -1, 1088230576, 1202652322, 269497844, -721669388, 1031553021, -570671363, -1074464783, -1090766851, -1078640647, -1078263109, -1, -65537, -1, -65537, -1, -1, -1, -1, -1025, -4097, -168318277, -21830, -65, -1, -21846, -21845, -134742025, 1431369040, -134219785, -705298443, 1430781951, 1442185215, -134217729, -704643073, -129, -1, -1, -1, -235, -8388737, -133, -1, -858849554, 1086652412, -1, -706609154, -1, -1, -1, -1, -257, -257, -16851202, -228408630, -9132, -8396929, -134331320, -26818482, -84939230, 14937003, -1593925630, -522191186, 1886872070, 1165195013, -210242814, -135266321, 804208439, 805257215, -49353, -2146497, 783757226, -1073741825, 2147429676, -1, -65, -806354961, -269486110, -1934692433, -93, -809500673, -705178880, -957349937, -1875839760, -229377, -4227073, -49153, -1078411336, -344065, -1078411333, -1346695749, -185598014, -1058081042, 1877999471, -269484049, -145230012, 1156972533, 2139094863, 1333788543, -1364545613, -1432211670, -33554573, -1146997982, -1073741825, -830996609, -1, -32909, -892424690, -4145, -67121153, -49, -18370673, -4178, -268455985, -1427182074, -261032720, -587432195, -131073, -50691, -1129267280, -1073954819, -1078411271, -1413808069, -1431687361, -100718018, -1430605953, -1140872462, -1081459393, -32898, -1364250833, -5293142, -13, -268435521, -1048592, -15, -33, -805306369, -134219824, -671088649, -1943994892, -590861060, -1073938435, -1107514116, -1086799943, -1364656195, -1073959937, -1079310149, -273682449, -357912854, -276829581, -496046880, -2097153, 1199570943, -136317069, -537921537, 287569152, -251594832, 2146920213, -134217787, 822601649, -1140398091, 926356740, -708328300, -851974, 1142216448, -126845168, 1089820437, -18945541, -536877063, -226774230, 33490763, -660044656, -1663300355, -1243807747, -1645371905, -1164394568, -1073742339, -1162302536, -1433793281, -1185, -538968065, -84410753, -218103809, -8423676, -8421505, -83891342, -8388609, -720907, -520294657, 2147336063, -1929400577, -11420911, -1175374857, -13287629, 469710719, -16777217, -219152401, -353370370, -521208070, -134219937, 2002517887, -201328809, -134219785, -260045584, -598735588, -541524225, 495721981, -1090732296, -190507, -8323139, 721949737, 1073801158, 274006015, -1158512641, 1004534783, 37879810, 1575972287, 593691278, 2139048459, -1371558217, -1359036417, -33554443, -269685255, -67125451, -269488161, -196745, -513, -358421790, -4003102, -886428113, -1170910, 1308773235, -143493257, 1735751031, -34989, -791494450, -774410553, -2131038209, 274739070, -261040956, -95003563, -67960838, -771559462, -16781569, -12620209, -663552418, -1302135042, -185121441, 2136301175, -152054020, -25690114, 2140813220, -35180561, -4292673, -7444574, 1072396221, -1, 351622176, 1957381120, -1, -1, -1, -1, -1, -1, -1, -1050845, -1, -16842753, -1, -65537, -1, -524289, -1, -1, -21569, -4097, -2121029, -23877, -1431651393, -1, -1140874565, -21505, -225, -1, -1, -1, -17136, 2105540479, -239, -1, -715786928, -145623126, -10753, -7697, 1431699447, -8912897, -536870913

        , -1, -51380242, -993198084, -1049601, -572653601, -134217729, -570425345, -1, -1, -285217278, -1360007185, -16781650, -286331154, 1946120967, -129, -134777088, -1054972, -285216769, -352387073, -285802497, -521208070, -129, -159383681, -41, -151584777, -31392272, -1135120, -1, -2358064, -1087324239, -262145, -13271041, -6617839, -454756380, -453181441, -269548283, -49, -1280134222, -4097, -1346426080, -20561, -126, 16908034, -738200816, 285341472, -4194389, -1951924305, -135268446, -1347420165, 997916671, 2066939903, -12582913, 1002438655, 716833418, -393217, 570557006, 988497759, -17830145, -4369, -496309506, -218109202, -698890681, -8436625, -463274754, -134218033, -1058020958, 10674851, -441457408, -705694225, -1241516557, 16185335, 1979708919, -707790849, -1103485135, -285573121, -32769, -1359151105, -32971, -1, -49363, -8197, 475010132, -570681891, 763314173, 503070591, -1083147792, -491535, -1078444039, -1078260549, -1059066073, -11425005, 1089597823, -176951259, -1399738449, -481164544, -395117831, -255266622, -1364541441, -1360072962, -2093, -822292747, -1, -826277897, -671090697, -536875009, -268435461, -357892186, -324014096, -1977025878, -841089032, -857743361, -978849664, -860880990, 135791824, -33815312, -1879048193, -1073931011, -1145506307, -1090650113, -1078247425, -1078260485, 1433892144, 859258672, -33017, -1111493326, 1976923645, 1073479615, -16812657, 800060330, -554632972, -50803492, -73729, -134443780, -1090912259, -1073881603, -1073890817, -1413803777, -83951755, -50380720, -1431815377, 721364994, -134744271, -8875, -5587153, -16525, 1078067454, 1358171637, -353210626, 583009978, 1919027036, -19120131, -71827457, -76501282, -8390108, 202178092, -336613845, -1347420657, -142609551, -147343499, -1591773, 792721215, -268435457, -1964315922, 2147481591, -286263556, -5242881, -1948259841, -142608393, -1, 1879091848, 2121789165, 2134751737, 808487458, -83, -1, 2145884552, 994019978, -16781814, -453316626, -286528990, -999555411, -212371712, 276051781, -145490429, -213385233, 653721621, 1610612607, -285212929, -268468225, -1342241788, -412622991, -1931113332, -1359020033, -291049729, -68227345, -56004817, -1429982, 2009038647, 2147450879, -4227205, -32905, -1465905927, -1929895524, -264195, -1346884435, -1110196235, -273186817, -1075838977, -1079305859, -55575314, -202213729, -524353, -13440458, 104875214, -1006615035, 1601654511, 1594050059, -67108897, -948045833, -17008, 1355874266, -67109427, -905969713, -201329984, -201326625, -559901296, -553874179, 1073741821, -37879811, -1087324995, -2162689, -1078411843, -1882717735, -16781569, -2109457, -956373825, -227868673, -545263032, -547965865, -60885286, -229441538, -76021762, -17108226, -553913345, -286335762, -542736, -185533964, -960, 1196412751, -72089944, 905940381, -117571860, 433057775, 1912565924, 822465813, -176174136, 21491528, -65542, -1058080777, -2408685, -830781953, -984464, -1057705987, -1622716661, 1337413403, -823140353, -26544146, -1048833, -97584902, -542376065, -25170049, -2602, -2828, -3365974, -80744785, -4280641, -38862930, 1962739133, -40961, 1433753260, 1889887362, -1, -1, -1, -1, -3, -1, -3, -1, -1, -1, -1, -1, -1, -1, -1, -353702193, -353697793, -67108865, -16842753, -67108865, -8978433, -67108865, -1, -1, 1542717439, 2147483647, -1, -65, 721355518, 2147446783, 587137279, 2147436543, -4196559, -1007683585, -1514801904, -134217729, 2004350769, 2004350839, -2255, -1, -4097, -1350829136, -285430224, -1904935120, -922989520, -1610654598, -864801248, -50462730, -269488129, -286330881, -1, -286333697, -1, 1342177279, -1, -1, 1427240304, 1427174688, -705441313, -174721661, 486604795, -8912897, 231734783, -2065, -797960976, -258818, -1073758209, -58115, -1145192520, -49156, -1074020353, -1078261606, -16781585, -16777489, -488453462, -253564178, -687881148, -8421761, -151563200, -151519489, -1342197953, -1342230721, -167792847, -1879101647, -1896903544, -1879064577, -673281864, -1881305937, -252643856, -17033988, -8536065, -189187, -196624, -410116, -1073889287, -1074069445, -16808929, 2147483519, -285212929, -150994945, -310443004,
        1300234047,
        -1459649396, -285212673, -84934714, -422641682, -269488305, -269486097, -144705724, 1165491574, 2145386319, 1331691343, -802139024, -587718657, -1073922051, -1073790977, -1078936656, -17104897, -1078181889, -1077989957, -134271105, -12644513, -285790465, -164319490, 1862221695, -8421505, -286323649, -8712353, -49, -909115441, -3154688, 1086649154, -603980404, -2067792481, -134745152, -771751937, -269491550, 11267875, -352329728, -1058148630, 1997907780, 82302263, -201866750, -707794993, -285266409, -285212801, -289406977, -273678401, -32971, -75497601, -221377, -4194817, 275837168, -789027076, 1056735229, -537125123, -1099646992, -1095221515, 1073725437, -1145372485, -176949257, -267321385, -1355546860, -184528382, 1902508031, 347094463, 1467315023, 1426081538, -123730736, -524076, -33619969, -6551332, -1154433104, -21118983, -1015875, 990385425, -5, -815792129, -2623696, -528400, -81, -822083649, -134744112, -134217737, 1086999118, -620884210, 774831962, 275279390, -721494322, -16777516, -67436550, -100466758, -353480978, 1659218687, -21230804, 1627327215, 1970765636, 1156544223, -151225488, -167817473, -134742017, -320033617, -184697153, -1362318097, -524361, 536949764, -13254891, 4547351, -1427206601, -1360080897, -1207963649, -1880232193, -1074151563, -2097669, -1615069321, -71303175, -172121960, -134238481, -170009607, -710366550, -135266887, -1, 1596264864, 1430061195, 90359434, 856817521, -352325982, 292615664, -12745010, 1073715133, -151025016, 552649344, -252651536, 2097045502, -134234113, -189955, -1073824336, -1074088196, -1073758277, -1141169218, -227285502, 1886813887, -1569545694, 14868477, -227319292, 1618443877, -214433905, -212336657, -282088533, -500520286, 1306210080, -1058668000, -1075317825, 1176172375, 2002196435, 1476384247, 536919472, -1157841160, -393217, -1073792003, -1082671371, -1073916195, -1073774593, -1077997953, -1207913424, -38005276, -98307, -35873003, 142652880, -1090636353, 521149917, 231211345, -536933281, -129, -20971521, 1660944255, -100711340, 1560280927, -285674292, -9175073, -17832194, -571793, -227389698, 1886578254, 1413891654, -61911794, -59322753, -25723041, 1142959120, -35910256, 2138929151, -35830275, -1109640912, -1078624836, -1073791041, 999884057, 2087939752, 530312111, 1912595058, -5374296, 1087786239, 2147430399, 1416979960, 1961161966, -532220336, -456236814, 1145372245, -856703761, -17631728, -10485779, -216943791, -3145985, 808694048, 10662688, 2112321329, -33688065, 897361331, -1992360007, 1967076657, -704662063, 3151088, -185058178, 175390580, 1442332382, -1497581580, -1107787851, 1005436920, -1409609542, -2157, 25933571, -202443456, -1067190480, -1778395776, 79682998, -524352, -839909377, 758001457, -1460127746, 2128601087, -1905476914, -8638704, -53507, -17481983, -891813712, 49414398, 408947263, 721160831, 679087262, 2137001583, -58769555, -1156646209, -68399251, -684282344, 272117024, 536788893, 420077471, -1280211808, 3410948, -1476491096, 151751835, -38273, 2029153135, -1375813761, 402718458, -1097388, -8437939, -17031388, -96141676, -285954061, -286330915, -10411, -289116559, -50637, -337117185, -673963, -539146379, -1, -1, -1093, -67130693, -1, -1, -69, -67126597, -9, 859043635, -1, -134217737, -2049, -1073741825, -1, -1, -1, -1, -1, -201326593, -171, 2139094911, -141, -1, 1078249166, 1440088063, -1375735809, -1, 1677131951, -12289, -4113, -4113, -269488129, -286609666, -268435457, -286350593, -1, 1207959551, -1, -1, -270, -258, 1875902066, -807409938, -14, -1, 2001207042, 2144336618, -1, -1, -14487830, -1121558, -2097281, -137, -12517546, -11536649, -19005532, -4185, -1, -4177, -135266385, -4178, -2129, -288365054, -13, -89, -134219792, -168296463, -85, -805310549, -134219789, -1, -655303172, -504321, -65537, -57857, -1137656392, -499715, -1078411336, -1078262341, 1074851070, 1280658654, 856947967, 1896963295, 1079035124, -562115521, -246285313, -8913153, -9, -857742353, -268439584, -454098962, -49, -805568513, -402668416, -1058013186, -654517028, -598735536, -66049, 420503005, -67305476, -4100, -4391169, -1172767016, -791620368, -654549762,
        2147287029, -33736195, 335558128, -1125091852, -5193795, -1145368133, -486617534, -1024790785, -287355377, -889229585, -823865532, 1157255151, -808497329, 1342132063, -352391425, 40565407, -1474256336, 536936126, -683386300, 1213226613, -162210048, -27918348, -587213820, 337056853, 213634061, 211804127, -50348920, -1870664323, -1430280056, -1430257665, -219091072, 1433732373, 586230579, 1173821203, -97845329, -32897, -1145847893, 2012704523, -1359016909, -285246465, -1409552451, -268435473, -49355, -4456449, -1075183867, -4206661, -285220350, 44039103, -285282590, 16115694, -8440060, -1157897353, -137470, -520097841, -2135371532, -17035780, -1073807361, -152323, -1174601732, -197155, -1078149125, -1073804545, -16790817, -83947905, -226723074, 1349185150, -696269300, -562557148, -730805032, -268238886, 259466515, -1352716489, -34196207, -550433757, -2133545030, -1883258949, -2848070, -287399286, -1945447184, -537387812, -1342210049, -1073799683, -1161841159, -1073741827, 1069498367, -1078262593, -486558859, -251681548, 181021444, -1997635520, -403708091, -705239563, -269549753, -16779275, -1997003568, -50593572, -1077035011, -1074000675, -1141522511, -1097793, -67567873, 993727517, -16785580, -288407697, -545333392, 309524254, -44, -268444171, -151062848, -92602702, 135270512, -1929507203, 1069487613, 805257215, 1044264052, -1073906179, 800735099, 800788026, -239078493, -1058888830, 2111828245, -704645643, 1937242035, -2036932617, 1433891109, -976235009, -3101, -807403537, -134219936, -76546438, -117, -1962934785, -134744128, -135266305, -1137699536, -247299, -33718531, -8602115, -1146050288, -1073815817, -1095229668, -1884811779, -18415874, -4182, -151587074, -42991954, 1077953766, -2040512506, 1414808799, -548977585, 307841834, 1027600298, -1074910176, -4198624, 1080970495, 1073704958, 543180014, 1898463264, -152043793, -35393809, -93919666, -219218226, 1984906823, 2004317542, -144190400, -145230241, 135414864, -392108, -40961, 1073682431, -1713594736, -1612161444, -1074249735, -1078258145, -68180350, 15655401, -419772928, -1058017297, -716704255, 4584773, -185079983, -705964561, 858435210, 976809983, 2147462654, 573746778, -21073, -65537, 2147323534, 997953034, 235671313, -1971016705, -20513, -1896960353, -1229547, -4194305, -1073922251, -2584644, -293545004, -553895690, 1073364983, -1107482115, -1355481168, -67305988, -1078935649, -1953822711, 2136962766, 564997806, -570460931, 800009647, 1416910196, 2003533823, 1576949759, 805261295, -135803635, -671088937, 2029878924, 2096480255, 863376896, -168331307, -134957940, 1985213235, -125834012, 269805092, -269619331, 536727517, -62937115, -1524619852, -1892700177, 152033755, -1414812741, -1431650386, 1744774963, -657006600, -134218253, 78568161, -143132745, -674237953, -3145988, -58980612, -286273793, -1399853841, -145245391, -110087823, -212862153, 692054783, 137251924, -50397442, -1885716481, -85274890, -353994924, -8388609, -10977420, -360786736, -184913904, -994140033, -1847820931, -1929379843, -1186808928, -1392623873, -288051447, 168785695, -65008432, -505872, 1040084991, -8567596, 1059073968, -1095778569, 2146908155, -539033207, -285280321, -287522837, -4325491, -272766209, -75497677, -5, -65665, -71569925, -218634513, 1375465405, -1468596516, 1886650111, -531389372, 1971273012, -228343926, -216793329, -1077936368, 787808254, -1345339715, -1342701585, 939512201, 888929911, 1068736184, -1476396294, -84152693, -26218545, -287377334, 1351024622, -69310720, 1583281950, -145240762, 1884487454, -92274700, 1951704920, -1376784417, -1356886785, -2830924, -1108019212, -1074925763, 191884159, -536877169, 322041621, -25428112, 2109731667, 2113890182, 261578679, -566, -118424590, -1, -1, -1, -1, -3, -33554433, -3, -1, -17, -1, -35783762, -4194386, -4097, -1, -3831638, -134231122, -178915856, -9043970, -570436363, -1, 1561460735, -8912897, 1606409727, -1, -540016692, -589496324, -4, -570556418, -3, -50331649, -1032, -117440518, -268439553, -286330881, -1, -285212929, -1, 1207959551, -134219777, -1, -4165, -285212751, -285938176, -318963801, -16781637, -1145327701, -17436873,
        -4177, 573910847, -14744030, -1364021313, -153425, 1073692479, -143184001, -1346687169, -53317, -109, -538968097, -134219823, -167772161, -85, -1078984785, -134219853, -5, -1, -1, -1, -1, -1, -4113, -33, -352326137, -16777217, -152043537, -16851202, -253563190, -67109041, -8388737, -2097340, -134744234, -30351884, -2618116, -8193, -4453123, -1145258504, -197123, -1078394881, -1078326213, -454035465, -923861505, -286282747, -823144881, -151586830, -218169345, 610541600, -318767105, -860859152, -17036036, -1073774593, -16385, -1094860808, -1073988100, -1077952513, -1077993537, 822325552, -1850608240, 1073681717, -16481, 926266813, -1077936195, 1067398449, -2122307, 1114768079, 2063273727, 586346239, 584822527, 1719354959, -193048961, -134222849, -201330945, -8945, -67108865, 989321823, -757071905, -8421376, 2002747219, -218449406, -209715205, -17903922, -67154193, -488444162, -226516242, 1078214724, -565296057, 2084855519, -8435897, -1945106188, -1932786468, -1619984897, 260574621, -475143, -3, -1073741825, -1154998467, -2097157, -939462480, -859877208, 67130496, -272632389, -1910261958, -2017729886, 135004075, -366809374, -1408278, 790760739, -546963422, 656568306, 1205038583, 1598379895, -43177, -1744783184, -51114756, -394243, -33804971, -1207918664, -86018, -1156530243, 193462685, -671249480, -12669013, 1922303737, -1281318151, 1610554797, -4256321, 1350326237, -56296227, -193, -16777217, -285220865, -1, -715, -8388805, -1185, -6291489, -68162902, 2336718, -524296190, -990908534, 1947682310, 611546950, -148376058, -212863058, -50397478, -706930347, 1626406673, 1172265743, -1310785, -807403569, -1142177861, 2145335323, 68162576, 1559758896, 261898101, 502794298, 674502640, -1091289551, 1065037819, 725295162, -257, -6417, -16843010, -219619618, -8353, -8388737, -16777353, -134217729, -27101391, -54641665, -4194305, -237633, -43, -1, -287310371, -589529763, -93, 1244196671, -272630880, -2010473046, -570427477, 234618303, -772280192, -704643110, 1244814864, 1601832016, -106625, 536555127, -1365713700, -106497, -1074249729, -1078260517, -289472517, -286330881, -4194313, -268484865, -1, -805306369, -5, -1075054337, 1482542300, 1600638431, 5098740, 1600119000, 1073779761, -8749059, 1882583551, 1937241599, -30343696, -2575108, -1078132739, -217891, -1342636047, -1145292811, -1078350855, -1078263589, -827392222, -17896730, 2121789172, -85002500, 707768183, -327520793, 1196905540, -570436364, -654404592, 419170553, -1941979297, 299183615, -118969208, -16780210, -1306477944, -1433760545, 552767180, -1157976338, -1073782817, -1196396850, -1141928052, -69665, -1211117684, 583962508, -3290, -234920065, -1905612244, 1348529583, -143132923, -227183276, -143409393, -216797345, -1095827680, -1595736834, -1343303707, -2063730692, 2013262647, 595033911, -1086343237, -1245708353, -100664321, -86069526, 1342173183, -286261585, -5199, -254497116, -4269, 1868558091, 2146953090, 524025649, -285364576, 502923057, 2113369280, -1078002809, -54858098, -1431765350, -367861162, -620879138, -1157993633, 578423395, 1146228292, -562607538, 2139049551, -268744113, -218175582, -1058362454, 1609752996, -570675712, 625125111, 8690, 997529075, 1157824538, 341843792, -19132420, 897529855, -1073900041, -1086537800, -16842753, -1077968961, -1146418022, -547362821, -336658450, 359652208, -867241236, -1078984785, -1940914224, 1440216532, 1162343856, -353571073, 1672458239, -2216191, 2045382319, -33587916, 1862233975, -32908, -69238785, -1372935184, -288707348, -1091076107, -269736236, -1074546761, -285235203, -134776873, -1074854787, -1066902048, -856542888, 1056845560, 1576543290, -1485794063, 683157499, 804040696, 792397883, 1809645752, 1342156526, 1970959034, 1340812970, 1325366577, -65, 95748144, 1336869034, -525082070, 8579750, -528752478, 552002474, 1884504068, 1449553783, -260770044, -260770940, -803163984, -16991499, -1107427329, -570618627, -1105150032, -1073828033, -1350254664, 250500223, -681580713, 1274011503, 2143254391, 672135148, 2147479380, -807403681, -671614992, -218431532, 47370320, 16256220, 805187455, 268183135, 278506416, -1711782724,
        804196153, 262669577, -810553429, -825557330, 938997745, -859310870, -8390657, 44982223, 1461974855, 1474294271, 1358577919, 1434324479, 1257697279, 868306943, -1334557604, -596347306, -359596050, -43843713, -16783617, -17865233, 1792958207, 1880817662, -184826034, -551911865, 2086010078, -264044546, -570452544, -737085040, -340524, 1440088061, -43000404, -2147359616, -1613770520, -1984958513, 1964986624, 29194160, 884945920, -1644593483, 1367307701, 771612666, 2122257727, -1933705491, -151219116, -553869825, -105120001, -10620961, -1090798320, -41959619, -1073828037, -1414918273, 1846017141, -285147212, 251604991, -1363686145, 2032661875, 1796308561, 796342143, 775942395, 782904871, -1430340129, -1480660059, 787220588, -1342604428, -306184225, 2134603633, -1423422340, -12305, 358348607, -34084910, 298958325, 1601963983, 10303319, -143416, -1329860922, 1903289380, 398438026, 1694261797, -1210081140, 537196735, -1309807115, 541565487, 860842498, -72365333, -392470, -88183094, -218734354, 673598534, 1310873171, 2052474062, -80513070, -1, -65537, -1, -65537, -1, -1, -1, -1, -1, -4097, -21761, -21761, -65, -1, -19781, -21761, -209, -1, -65, -1, -235, 2139094911, -207, -1, 1963325184, -134873089, -243, -1, 1968504829, -1208483841, -33554961, -2097153, -665780225, 1566433279, -67108865, 2147483647, -800000771, -1, -260971265, -8241, -285212845, -268435457, -992682415, -989986849, -267281, -273944693, -1, -37, -352399617, 1089466095, -1027454238, -520163585, -142641377, 1090518847, -144836649, -137887745, -536870923, -1915814404, 217844784, -858981148, 1307956720, -1665271835, 1291113616, -573636656, -1272929136, 270540080, -1078132740, -37954308, -1086800456, -1465903819, -1078935621, -1079304769, -5245659, -1052753, -1, -1048657, -2101331, -1, -34603587, -273713919, -1, -69009425, -17895698, -219218198, -8388737, -8912897, 1901547588, -134220033, -228396294, -202226957, -14508290, 2133983846, 1879097590, -223328525, 1879070454, 2066956871, -68163926, -1058029617, -391469566, -990908945, -210508025, 1073904453, -147327225, -9175089, -117910320, -589558532, -1074201091, -33764099, -21446984, -16843057, -1094141000, -1433926471, -1049677, 33815299, -706743888, -1048314640, -542113877, -1976829013, 1374679232, -542113797, 841908223, 1001270063, 939417463, 539898418, -570458369, -285216769, -34817, 1962899455, 451941456, -34066690, -163841, -1107353601, -1078412360, -1073905665, -1079459845, -1346761573, -16777473, -4369, -218174722, -218109329, -143657089, -8433809, -185340161, -134224129, -287314129, 1105196031, -268439553, 16772847, -76022266, -83893018, -8951033, -352326074, -252643600, -518916, -65541, -537053441, -69666888, -67584040, -4341768, -1141178117, -1359007821, -285298689, -270536705, -1347588739, -1074004107, -1, -129, -1086328961, -724564976, -573307888, -34766855, -572698215, -389780044, -153691, -30621767, 453014553, -1057881906, 1358909183, 1660563419, 1617620991, -260914108, -730708715, -231669782, -234684642, -541067343, 67305216, -407899727, -1917845599, -1409286229, -1960575069, -939527773, -1946157125, 1492897792, 217904348, -1644175875, -1342185729, -1200441192, -1196380627, -1157775480, 719322079, -1347704149, -1565873494, 1069512401, -41222976, -268437505, 183496695, 2011166535, -705693953, 1004382895, 389223731, -202003951, 1362209296, 1182715567, 1044119357, -604977014, 1400097536, -134230257, -257, -1160511781, -757071905, -202648000, -159383753, -67436782, -209978401, -386470194, -923223042, -268521812, -570677012, -1275808835, -1427504650, -2769173, -538238789, -290582767, -318865409, 787955711, 784317437, -49388, -2049, -543347945, -1359311109, -98385182, -87938322, -537235714, -67376402, 1141130308, -899527857, 2137279950, 2066958151, -521994428, -520422285, -1899954353, -858785861, -235405756, -251789825, -65, -257, -134220837, 81769471, 1366814992, 291371891, -39864950, -2135957105, -624961400, -1728053265, 402659120, -479240, -136691747, -246340, -1138212892, -1090907207, 253235645, -1880337024, -588381024, -84269122, 775040828, 2134387242, 4195764, 677520179, 1465320891,
        1325605947, 235284000, -219742512, -553666564, -16843012, 705095428, -286892043, 220030420, -540031808, 1103088, 1859923952, 1073643485, 805247231, -1082278480, -4727297, 1065302975, 805244346, -838873593, 718923495, -1795, -1997541393, 1918333235, -34743327, 2004317219, -355535102, -252510992, -590051308, -277291041, -1108509057, -1082671183, -1079307343, -4325377, 722431871, -1052689, -423465014, -285219076, 1357313770, 2134891599, -30247041, 1467445826, -9964066, -286329360, -890319652, 804193045, -269549499, -1566376014, -2441246, 863187728, -1076940292, -536879137, -847286401, -1409319110, 4234350, -2688, -570426279, -134219840, -785711142, -2145321168, 469809204, 804716308, 1606266495, -1087064399, -1365185419, 791785400, -1959019365, -299700493, -72691990, -1080857993, -1400608, 925938675, -805661449, 1444095999, -323247, 1491138032, -17154310, -1179697185, -1074844161, -1145260559, -1610646017, -1073774593, -1077990593, -84021718, 2006617002, -55054814, -34736498, 1348949119, 1430200870, 1682011311, -733546778, -1348756207, -287539361, -1968766977, -1392657155, -16793839, -1166082179, -537067691, -289901219, -16783633, -202379289, -487921074, -253034902, 1180648519, 2053597011, 1693832278, -143132841, 139067536, 417858263, 251538167, 136847192, -1208610824, -78709249, -268500998, -1343082498, -131932972, -60011340, -33693699, -537051683, -1153892420, -1399030283, -1347436549, -1146415681, 354899376, -1749475432, 1069298997, -7342083, 831796405, -1342443571, 891684145, -1074922099, -274008073, -420806676, -67115531, -289546755, -1343225857, 1325400061, -201328649, -541065729, -201853168, 2010464085, 754376376, 82158759, -143136908, 1970615621, -2363686, -2006996737, -128928272, -151241134, 1333737471, -248193, -1208959496, -1074217031, -12730439, -1342496581, 1461837645, 1204767951, 918871903, 1088871626, -213975525, -552611953, -214699149, 1158147599, 2061697023, 2102426751, 1513127933, 2130745502, 2120506844, -13992515, -9431700, -9089712, -4194389, -290460694, -642259150, -1573912, -70254593, -1905266706, 1442836981, -708313636, 244256273, -320565380, -2158659, -1346753299, -1108525291, -16777218, -1622223, -160944, 1439519868, 1873784360, -67108873, 665792939, 1414878581, 1878474236, 2113885685, 263159231, -672666400, 286647716, -1094725636, -1648361729, -152074780, 19239172, -1913917462, 166723019, 1743626928, -420634882, 637302065, -990427904, -1564821693, -75563009, 76381556, 177133442, 1517285295, 2075656127, -595661278, -530294, 70600703, -1577105417, 1927444703, -79736621, -265357438, -1058363734, -596704, -34626370, -1275855897, 2504628, 2102916437, -984648197, 1174028208, -33685569, 2075122104, -1376342, 2147418033, -131073, -570436432, 211861418, -537933053, 66570159, 141527552, 12048365, -75776510, 117912157, -1565285472, 576711647, -603992401, -6709, -1603301829, 1380638434, -545293310, 1578329680, 1937766358, 1346567774, -67184427, -570487041, 1728012191, -135430145, -16768, -134744225, -1163085144, -1423261717, -126943758, -218447953, -39523458, -139993331, 1480853476, -990887921, -35367169, 2131182091, 13550805, -822411778, 1065330673, 787280620, -1409318411, -1101008897, -404228175, -1440424907, 35714048, 15794164, 263186879, 502661117, 1467426566, 931135359, 805252875, 1061125903, 212517904, 1594363328, -1518340647, -3207944, 799777201, -1348944719, 1073722875, -1074850561, -489706838, -337117331, -453595344, -453853449, -780672479, 206401475, -151077100, 1693482869, 1415315472, 1570504976, 2147295027, -572719619, -1107479115, -160331, 2142056889, 143141277, -8395102, 20177827, -487667678, 552989410, 2002743556, 125122235, 1676993282, -253368626, 3169904, 452876222, -33939459, 805246711, 1026835508, -16875777, 985151867, 733676602, -75497533, 1393032963, 1497363296, -1719140495, -268439638, -2069910098, -676335392, -2131757089, 242114388, 110784262, -1074301100, 843738714, -1572912, -2166988, -134227984, -97845262, -536930289, -671090854, 171340410, 1651470335, -25479680, 2055163734, -93457672, 1514332922, -1094834147, -285217556, -285234371, -25507755, -1079321312, -72195, -1364545782,
        -85155580, -256852748, -454547970, -6162817, -1342696259, -1352908867, -4194307, 1069381055, 790301997, 2010735401, 355667729, 818938368, 286296576, 206442219, 84542500, -1058486136, 270594560, -419542017, -629217281, -352420099, 16317674, -8422043, 1719664575, 1714845558, 1390863604, 50528256, -930433632, 804742993, -134284052, 285718459, -1989214731, 118969349, -846281276, -340005973, -1901139602, 1023409874, -1060469508, 2137913023, 113503222, 1968698689, 1434440393, -804863770, 1357860343, 552001471, 6352891, -261749244, -78686379, -77271057, -214237189, 850815886, -1603124242, 1870064126, -269828946, 355542927, 1082157039, 792166031, 1326675579, 1600120445, 1413527068, -1358991772, -1920631583, -12584585, -176851627, -1074006269, 791674687, -54897419, -184664961, -50348257, -152583, -4276592, -90497, -1078411365, -1413806913, 738536449, -1632874754, -1612832865, -1821604437, -1078149307, -17039873, -810466876, -1427359740, -66929615, -2219012, -51020097, -42082563, -1147076844, -33588099, -1347904229, -1414849185, 931408, 345508574, 536416255, -1611915539, -1073954912, -18202732, -1098044744, -1883568070, 46328558, 31141629, 179187386, 799223789, 2044876646, 2061913902, -1100296241, -12227291
    };
const int16_t  cascadeLeaves_[FACE_MODEL_N_FEATURE * 2] = {-9309, 6815, -8975, 4332, -8691, 4237, -7043, 4927, -5480, 5814, -9213, 4284, -8300, 2599, -8103, 3363, -6101, 4773, -5217, 5734, -3525, 6175, -6233, 3570, -4020, 4866, -9256, 1958, -8148, 1387, -7274, 3491, -4734, 5844, -5184, 4485, -4410, 5149, -3560, 5682, -6425, 2901, -4127, 3894, -4990, 2932, -9008, 1338, -8210, 935, -5434, 4631, -6397, 3621, -3791, 5787, -4326, 4715, -3656, 5074, -3407, 5114, -5026, 3343, -4851, 3089, -3579, 3481, -2971, 4292, -4240, 2780, -8723, 288, -6635, 3520, -6173, 4162, -5576, 3612, -4015, 4787, -3840, 4808, -3574, 4781, -4291, 3502, -4391, 3072, -2933, 4221, -3325, 3783, -3494, 3482, -2695, 4428, -3069, 3824, -4637, 2274, -2768, 3830, -8675, -105, -6325, 3001, -4272, 4927, -5200, 3347, -4134, 4026, -3963, 4511, -4614, 3298, -4091, 3243, -5008, 2392, -3476, 3936, -4597, 2629, -4219, 2725, -3245, 3319, -2319, 4407, -3277, 3319, -2563, 3862, -2754, 3803, -3277, 3324, -3388, 2877, -3802, 2484, -8830, -2, -6605, 2779, -5947, 3130, -4199, 4386, -4204, 3497, -4491, 3134, -4574, 3019, -3370, 3663, -4642, 2483, -3667, 3114, -3138, 3094, -2932, 3239, -3221, 2904, -3149, 2736, -3762, 2392, -2050, 4022, -3121, 2650, -2102, 3983, -3436, 2359, -2874, 2709, -3701, 2119, -8932, -2132, -6269, 2581, -5756, 2995, -3891, 3843, -4810, 3187, -3424, 3785, -3423, 3798, -3459, 3137, -2298, 4371, -3350, 2939, -2678, 3493, -3365, 2938, -3299, 2736, -2920, 2924, -2491, 3423, -3151, 2506, -4237, 1819, -2358, 3293, -2300, 3361, -4273, 1820, -3389, 2168, -2732, 2485, -2847, 2397, -4082, 1655, -2262, 2909, -8254, 295, -6551, 1653, -3921, 3930, -3022, 4910, -4506, 3338, -3490, 3330, -4389, 2349, -3609, 2822, -3030, 2970, -2203, 4072, -4263, 2072, -2945, 2925, -3180, 2660, -2295, 3648, -3253, 2414, -2202, 3544, -2134, 3565, -2289, 3240, -3362, 2115, -3987, 1812, -2513, 2720, -1861, 3607, -2660, 2425, -2728, 2276, -3475, 1855, -4084, 1464, -2281, 2673, -2767, 2201, -2324, 2618, -2127, 2730, -4540, 1342, -8389, -1211, -4939, 4376, -4209, 3497, -3573, 3567, -4757, 2675, -3493, 3403, -4348, 2402, -3244, 2835, -2481, 3384, -4559, 1772, -3119, 2576, -4136, 1926, -2487, 3041, -2932, 2454, -2700, 2676, -2415, 2955, -2574, 2624, -2489, 2840, -2882, 2328, -2379, 2962, -3891, 1728, -2051, 3418, -2472, 2537, -3384, 1864, -3490, 1762, -1824, 3425, -4048, 1507, -2957, 1900, -2725, 2163, -1996, 2784, -2223, 2417, -2291, 2452, -2225, 2429, -2240, 2393, -1854, 2944, -3397, 1569, -2960, 1777, -2739, 1861, -1846, 2782, -2912, 1727, -8187, -745, -5427, 2722, -3165, 4099, -5129, 2270, -2902, 3699, -2662, 3385, -2840, 3113, -4667, 1859, -2229, 3491, -3022, 2555, -3526, 2235, -2192, 3428, -2492, 2950, -3822, 1848, -2218, 3249, -2737, 2449, -3201, 2246, -3505, 1817, -2340, 2670, -2166, 2908, -3129, 1806, -3279, 1703, -1955, 2919, -2736, 2030, -3549, 1605, -3706, 1439, -2244, 2362, -3445, 1549, -3869, 1337, -1699, 3045, -2607, 1932, -2595, 1918, -2109, 2432, -3522, 1389, -1755, 2791, -2291, 2086, -2822, 1658, -2563, 1798, -3393, 1375, -3169, 1471, -2189, 2192, -2453, 1917, -3051, 1506, -3518, 1264, -2500, 1788, -2524, 1848, -2385, 1909, -8498, -3056, -4900, 2372, -3622, 3346, -4511, 2393, -3030, 3353, -3645, 2597, -2954, 2954, -2291, 3421, -1761, 4304, -1862, 4014, -3879, 1840, -2564, 2612, -3115, 2147, -2126, 3075, -3868, 1675, -3087, 1933, -2532, 2338, -3354, 1652, -2608, 2154, -3424, 1615, -1951, 2996, -2249, 2217, -2381, 2135, -1763, 2817, -2801, 1810, -2333, 2106, -2658, 1851, -3432, 1388, -1907, 2508, -1912, 2413, -2903, 1614, -1935, 2435, -4146, 1085, -2750, 1606, -2054, 2215, -2791, 1625, -3970, 1088, -2694, 1585, -1911, 2264, -2730, 1569, -2449, 1674, -1950, 2057, -1976, 2086, -2344, 1684, -3582, 1079, -2220, 1790, -1764, 2200, -1551, 2620, -1595, 2381, -2085, 1804, -2483, 1550, -1807, 2159, -1674, 2257, -8153, -1858, -6035, 843, -4376, 2258, -3797, 2471, -2931, 3189, -2318, 3381, -2874, 2500, -1463, 4324, -1452, 4369, -2508, 2517, -1979, 3023, -2661, 2182, -1891, 3182, -2966, 2030, -3022, 1816, -2083, 2750, -2665, 2042, -3078, 1644, -2921, 1694, -2450, 2066, -2776, 1778, -1574

                                                           ,
                                                           3251, -1730, 2854, -2892, 1691, -2885, 1709, -2752, 1641, -1887, 2428, -2149, 2074, -2281, 1871, -1899, 2312, -1371, 3079, -3112, 1418, -1588, 2632, -2676, 1496, -1993, 1995, -3909, 977, -1856, 2059, -2584, 1472, -2141, 1780, -1902, 2005, -2260, 1663, -2636, 1417, -1806, 2052, -2112, 1778, -1942, 1929, -2003, 1798, -2198, 1644, -4374, 807, -3238, 1055, -2096, 1694, -2116, 1652, -2852, 1234, -2005, 1733, -1826, 1863, -1594, 2124, -1549, 2142, -2886, 1174, -1610, 2085, -1995, 1645, -2950, 1098, -1722, 1962, -2640, 1246, -1789, 1843, -8134, -2251, -5377, 1457, -3786, 2344, -3983, 2316, -2823, 3269, -2133, 3246, -2384, 2855, -2919, 2167, -2302, 2588, -2585, 2283, -2712, 1981, -2733, 1876, -2597, 1945, -2399, 2078, -2149, 2363, -3404, 1458, -2273, 2175, -1820, 2501, -2333, 1961, -1647, 2885, -1789, 2613, -2773, 1606, -2680, 1567, -1793, 2328, -2357, 1758, -1831, 2318, -2853, 1444, -1670, 2393, -1636, 2405, -2386, 1622, -2526, 1544, -3586, 1042, -1777, 2155, -2862, 1284, -2371, 1519, -2926, 1228, -2319, 1526, -2257, 1538, -1421, 2592, -1801, 1912, -2760, 1262, -1948, 1713, -1711, 2035, -1513, 2306, -1516, 2154, -2908, 1158, -2288, 1470, -2456, 1335, -3020, 1093, -1235, 2612, -2263, 1407, -1473, 2204, -1804, 1809, -1446, 2247, -2468, 1340, -1838, 1755, -1433, 2238, -2142, 1479, -2860, 1075, -1836, 1708, -1860, 1631, -1748, 1890, -1836, 1671, -2174, 1402, -2207, 1335, -1992, 1499, -1231, 2480, -1685, 1732, -2544, 1129, -4148, 689, -1569, 1885, -2611, 1119, -2515, 1101, -2335, 1243, -2619, 1100, -1589, 1850, -2352, 1233, -1940, 1453, -1919, 1449, -1886, 1489, -2933, 938, -2348, 1175, -2335, 1160, -2224, 1213, -1746, 1565, -2000, 1376, -1920, 1394, -1029, 2578, -2240, 1198, -1273, 2148, -1842, 1418, -2643, 994
                                                          };
const int32_t  stageThreshold[FACE_MODEL_N_STAGES] = {-28204, -31209, -31617, -33945, -34230, -34433, -34526, -34783, -34817, -34151, -33599, -33337, -33091, -30746};
const uint8_t  featureRectX[FACE_MODEL_N_FEATURE] = {4, 0, 11, 7, 0, 4, 0, 13, 6, 11, 0, 1, 0, 4, 9, 0, 14, 11, 7, 1, 4, 0, 0, 5, 2, 0, 11, 13, 4, 0, 14, 9, 3, 10, 0, 6, 10, 2, 4, 14, 5, 0, 14, 3, 10, 13, 4, 0, 9, 9, 4, 1, 6, 3, 17, 3, 10, 0, 9, 0, 4, 14, 1, 12, 14, 11, 5, 8, 8, 0, 6, 9, 5, 7, 3, 10, 11, 6, 14, 0, 3, 1, 13, 9, 9, 0, 12, 10, 8, 10, 12, 0, 5, 4, 5, 11, 0, 2, 11, 9, 11, 6, 11, 5, 5, 0, 9, 10, 14, 0, 14, 9, 6, 2, 4, 0, 7, 9, 2, 4, 5, 13, 12, 1, 9, 5, 14, 8, 1, 1, 8, 8, 1, 14, 10, 0, 5, 6, 14, 17, 7, 0, 5, 11, 4, 0, 12, 0, 9, 10, 0, 5, 14, 3, 11, 9, 1, 3, 5, 12, 11, 0, 7, 9, 8, 4, 3, 14, 10, 4, 10, 1, 12, 6, 0, 5, 9, 13, 0, 4, 5, 13, 13, 2, 1, 9, 4, 3, 8, 12, 7, 2, 10, 17, 9, 1, 4, 9, 0, 4, 9, 14, 1, 8, 1, 13, 8, 11, 9, 5, 4, 14, 13, 0, 6, 5, 6, 6, 8, 10, 0, 9, 12, 17, 3, 4, 8, 3, 6, 9, 13, 8, 12, 11, 0, 3, 3, 5, 14, 11, 0, 6, 0, 9, 13, 7, 10, 14, 6, 7, 2, 0, 14, 5, 10, 8, 9, 3, 4, 10, 0, 4, 14, 9, 6, 14, 13, 4, 9, 1, 7, 8, 4, 7, 8, 1, 14, 9, 1, 7, 3, 12, 3, 4, 11, 14, 0, 7, 6, 13, 6, 3, 11, 0, 7, 1, 11, 8, 0, 10, 5, 10, 5, 11, 17, 3, 5, 11, 0, 13, 6, 12, 9, 5, 8, 0, 10, 14, 7, 4, 9, 10, 4, 15, 6, 10, 14, 3, 5, 5, 7, 9, 17, 0, 3, 8, 7, 9, 13, 15, 7, 0, 12, 1, 10, 4, 14, 9, 5, 6, 8, 4, 1, 5, 13, 3, 10, 5, 0, 17, 11, 10, 1, 4, 9, 14, 13, 1, 8, 0, 8, 8, 3, 5, 12, 11, 13, 0, 5, 17, 8, 9, 4, 0, 11, 11, 7, 4, 9, 9, 3, 3, 4, 14, 10, 2, 9, 8, 11, 1, 13, 11, 5, 3, 10, 8, 3, 1, 16, 6, 3, 9, 5, 9, 7, 6, 17, 0, 15, 5, 4, 11, 11, 7, 5, 8, 8, 12, 14, 17, 2, 4, 5, 2, 5, 0, 11, 6, 8, 14, 7, 13, 9, 11};
const uint8_t  featureRectY[FACE_MODEL_N_FEATURE] = {1, 4, 5, 0, 0, 2, 5, 4, 4, 0, 0, 4, 13, 1, 2, 5, 0, 5, 1, 0, 4, 14, 2, 1, 1, 11, 5, 0, 6, 1, 11, 7, 5, 7, 9, 2, 2, 0, 1, 4, 7, 11, 0, 8, 1, 17, 5, 0, 15, 14, 3, 17, 2, 1, 9, 6, 5, 0, 6, 5, 4, 0, 14, 7, 13, 0, 4, 14, 15, 13, 5, 2, 1, 1, 6, 6, 0, 4, 5, 0, 4, 12, 14, 16, 4, 16, 2, 15, 5, 14, 11, 0, 7, 1, 5, 4, 0, 5, 1, 7, 10, 5, 17, 0, 6, 10, 15, 0, 5, 4, 14, 14, 1, 17, 6, 8, 1, 13, 0, 2, 6, 0, 6, 11, 7, 5, 11, 15, 16, 0, 2, 14, 5, 17, 13, 2, 9, 4, 4, 0, 13, 11, 3, 3, 0, 5, 9, 14, 1, 2, 0, 3, 1, 4, 5, 5, 10, 4, 4, 16, 0, 14, 8, 0, 13, 6, 0, 11, 15, 5, 14, 3, 8, 14, 0, 0, 8, 0, 4, 2, 11, 12, 3, 17, 11, 10, 13, 11, 3, 0, 2, 5, 3, 6, 5, 0, 4, 15, 13, 4, 14, 0, 17, 16, 4, 13, 7, 0, 13, 9, 4, 16, 10, 4, 10, 0, 0, 4, 15, 8, 3, 16, 3, 0, 17, 5, 4, 5, 8, 12, 14, 0, 7, 11, 11, 0, 0, 7, 0, 5, 1, 0, 11, 2, 17, 14, 5, 10, 3, 13, 14, 6, 4, 4, 0, 5, 15, 17, 6, 16, 0, 3, 11, 17, 9, 15, 2, 12, 4, 14, 15, 8, 0, 0, 14, 3, 0, 12, 0, 13, 8, 3, 5, 0, 9, 5, 15, 13, 6, 0, 3, 5, 8, 0, 5, 6, 17, 2, 10, 14, 0, 15, 8, 7, 2, 16, 2, 13, 4, 4, 3, 0, 7, 4, 12, 16, 0, 12, 16, 0, 3, 13, 11, 4, 0, 9, 4, 12, 6, 17, 10, 14, 17, 3, 2, 11, 0, 6, 3, 11, 15, 1, 8, 17, 12, 7, 2, 14, 0, 5, 4, 14, 0, 1, 0, 7, 3, 5, 6, 5, 13, 0, 12, 14, 8, 4, 14, 1, 15, 17, 4, 14, 1, 4, 9, 17, 5, 0, 4, 1, 10, 0, 15, 4, 13, 2, 11, 10, 16, 4, 3, 13, 3, 12, 12, 4, 15, 6, 0, 15, 8, 14, 7, 0, 8, 13, 8, 5, 17, 0, 2, 11, 1, 6, 9, 1, 6, 17, 3, 12, 0, 4, 15, 8, 5, 6, 17, 15, 10, 0, 0, 2, 5, 10, 9, 0, 8, 10, 13, 3, 0, 2, 13, 7};
const uint8_t  featureRectH[FACE_MODEL_N_FEATURE] = {4, 5, 4, 5, 1, 3, 5, 5, 2, 1, 1, 4, 2, 4, 3, 4, 1, 5, 5, 1, 4, 2, 3, 4, 4, 3, 4, 1, 1, 1, 3, 2, 4, 1, 1, 1, 2, 1, 4, 4, 1, 2, 2, 4, 4, 1, 4, 2, 1, 1, 4, 1, 2, 4, 1, 4, 4, 1, 1, 3, 4, 1, 2, 1, 2, 1, 2, 1, 1, 2, 5, 2, 4, 3, 3, 2, 1, 2, 5, 3, 4, 1, 2, 1, 1, 1, 1, 1, 5, 1, 1, 6, 1, 4, 2, 5, 1, 5, 2, 1, 1, 5, 1, 1, 1, 3, 1, 1, 1, 4, 2, 1, 2, 1, 2, 1, 3, 1, 2, 3, 4, 1, 4, 3, 1, 2, 2, 1, 1, 3, 2, 1, 2, 1, 1, 1, 1, 4, 1, 1, 2, 1, 1, 4, 1, 1, 1, 2, 3, 2, 2, 3, 1, 5, 4, 1, 1, 1, 4, 1, 5, 2, 1, 1, 1, 1, 1, 3, 1, 2, 1, 4, 1, 2, 1, 4, 1, 3, 2, 1, 1, 1, 1, 1, 2, 1, 2, 1, 2, 2, 2, 4, 3, 2, 5, 1, 5, 1, 2, 2, 1, 3, 1, 1, 2, 1, 1, 1, 1, 2, 1, 1, 1, 3, 3, 1, 4, 2, 1, 1, 1, 1, 1, 2, 1, 1, 2, 5, 1, 1, 1, 1, 1, 1, 3, 1, 5, 1, 1, 3, 1, 6, 2, 2, 1, 1, 5, 2, 1, 1, 2, 3, 1, 3, 1, 1, 1, 1, 1, 1, 6, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 4, 1, 1, 4, 1, 1, 1, 2, 2, 1, 1, 1, 1, 2, 1, 1, 1, 2, 2, 5, 2, 1, 5, 1, 1, 2, 2, 1, 6, 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 4, 1, 1, 2, 2, 1, 1, 5, 1, 1, 1, 3, 1, 3, 2, 1, 1, 1, 1, 1, 3, 1, 1, 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 3, 1, 2, 4, 1, 2, 5, 5, 2, 5, 1, 3, 1, 1, 1, 1, 2, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 1, 1, 1, 1, 5, 1, 1, 1, 1, 1, 1, 1, 1, 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 4, 5, 1, 1, 4, 1, 4, 1, 1, 3, 1, 1, 1, 1, 2, 3, 1, 4, 1, 1, 1, 1, 1, 1, 5, 1, 1, 1, 1, 1, 1, 1, 2, 1, 2, 1, 1, 1};

float32_t scaleFactor = 1.259;// 1.259; //by default 1.259, users can reset.
uint32_t minNeighbors = DEFAULT_MIN_NEIGHBOR;  //users can reset.

static int32_t   icvRunFeature(ifcvFeature *feature, uint32_t offset, int32_t *confidance, int sumStride, uint32_t x, uint16_t num_n_stages);

int set_param(char *name, float value)
{
    if (strcmp(name, "alertFactor") == 0 || strcmp(name, "alertfactor") == 0)
    {
        minNeighbors = (int)value;
        return 0;
    }
    else if (strcmp(name, "speedFactor") == 0 || strcmp(name, "speedfactor") == 0)
    {
        scaleFactor = value;
        return 0;
    }
    else
    {
        return -1;
    }
}

//// object detection API implementation

void *buffer_2 = NULL;

bool init_object_detection(uint32_t Height, uint32_t Width, cvFacedetectParameters *param)
{

    param->maxSize = 140;//300;
    param->minSize = 45;//20;
    //  param->scaleFactor =  1.2;//1.259;
    param->stepSize = 2;

    param->focal_length = 1000;
    param->camera_height = 3;


    // init scratch buffer_2, to do, consider the hardware memory requirement.
    int maxDetectedFaceNum = 1;


    int memSize = (4 * Width * Height) + ((Width + 9) * (Height + 1) * 2) + (4788 * 2 * 4 + 200) + maxDetectedFaceNum * 100 * 16;
    //int memSize = (4 * Width * Height) + ((Width+9) * (Height+1)* 2);
    //int memSize = 1024 * 40;// 24 -> 60
    buffer_2 = malloc_ext(0, (memSize * sizeof(uint8_t)));
    //buffer_2 = (uint8_t*)((uint32_t)0x68308400);
    if (buffer_2 != NULL)
    {
        memset(buffer_2, 0, (memSize * sizeof(uint8_t)));
        //KUART_Output("malloc successed!");
        //char str[10];
        //sprintf(str, "%d", memSize);
        //KUART_Output(str);
    }
    else
    {
        KUART_Output("malloc failed!");
        return false;
    }

    /*
    buffer_2 = malloc( (memSize * sizeof(uint8_t)));// byte buffer_2 = 0x2001 4090
    if(buffer_2!=NULL) {
        //cout << "init_face_detection 3" << endl;
        memset(buffer_2,0,(memSize * sizeof(uint8_t)));
        KUART_Output("malloc successed!");
    } else {
        //cout << "init_face_detection 4 buffer_2 NULL" << endl;
        KUART_Output("malloc failed!");
        return false;
    }
    */
    nCandidate = 0;
    return true;

}

void deinit_object_detection()
{

    if (buffer_2)
    {
        free_ext(0, buffer_2);
    }

}

bool object_detection_process(uint8_t *__restrict src,
                              uint32_t srcWidth,
                              uint32_t srcHeight,
                              uint32_t srcStride,
                              cvFacedetectParameters *para,
                              uint32_t maxDetectedFaceNum,
                              uint32_t *resultFaceNum,
                              cvFacedetectResult *result)

{
    uint32_t r = 1;
    *resultFaceNum = 0;
    //cout << "face_detection_process ENTER" << endl;
    //  xTaskHandle hdl1 = xTaskGetCurrentTaskHandle();
    //  unsigned portBASE_TYPE uxHighWaterMark1=uxTaskGetStackHighWaterMark( hdl1 );
    r = icvObjectDetection(src, srcWidth, srcHeight, srcStride, para, maxDetectedFaceNum, resultFaceNum, result, buffer_2);

    //trying to fill in the car distance and time to collision
    if (*resultFaceNum == 0) //no car being detected, skip
    {

    }
    else
    {
        uint32 i = 0;
        for (; i < *resultFaceNum; i++)
        {
            int y = result[i].height;// how many pixels for detected car.
            //conver the y pixels into actual physcial distance.
            //  cout <<  para->focal_length << endl;
            //  cout << para->camera_height << endl;
            //cout << "y = " <<y<<endl;
            float distance = para->focal_length * para->camera_height / y;
            result[i].distance = distance;
        }


    }
    pre_result = result;

    //printf(" resultFaceNum %d", *resultFaceNum);
    //KUART_Output("<end object_detection_process>");
    return r > 0 ? true : false;
}

int32_t absdef(int32_t a)
{
    if (a >= 0)
    {
        return a;
    }
    else
    {
        return -a;
    }
}

int32_t icvSimilarRect(icvRect *r1, icvRect *r2)
{
    float32_t d;
    if (r1->width <= r2->width)
    {
        d = (float32_t)r1->width;
    }
    else
    {
        d = (float32_t)r2->width;
    }
    if (r1->height <= r2->height)
    {
        d += r1->height;
    }
    else
    {
        d += r2->height;
    }
    d = d * 0.1f;
    int32_t result = (absdef(r1->topx - r2->topx) <= d && absdef(r1->topy - r2->topy) <= d &&
                      absdef(r1->topx + r1->width - r2->topx - r2->width) <= d &&
                      absdef(r1->topy + r1->height - r2->topy - r2->height) <= d);
    return result;

}

int32_t icvMergePartition(icvRect *rectList, uint32_t rectNum, uint32_t *buff)
{
    uint32_t i, j, k;
    uint32_t *buf = buff;
    uint32_t *p = buff + rectNum; //first part to save label
    uint32_t *computeMark = p + rectNum;
    icvRect *r1, *r2;

    //initial
    uint32_t computemarkSum = 0;
    uint32_t classIdx = 0;
    uint32_t currentIdx = 0;
    for (i = 0; i < rectNum; i++)
    {
        buf[i] = 0;
        p[i] = 0;
        computeMark[i] = 0;
    }
    while (computemarkSum < rectNum)
    {
        computeMark[currentIdx] = 1;
        computemarkSum++;
        p[currentIdx] = 1;
        r1 = rectList + currentIdx;
        int totalNum = 0;
        for (i = 0; i < rectNum; i++)
        {
            if (computeMark[i] == 0)
            {
                r2 = (rectList + i);
                k = icvSimilarRect(r1, r2);
                p[i] = k;
                totalNum += k;
            }
        }


        while (totalNum > 0)
        {
            for (i = 0; i < rectNum; i++)
            {
                if (p[i] == 1 && computeMark[i] == 0)
                {
                    computeMark[i] = 1;
                    computemarkSum++;
                    p[currentIdx] = 1;
                    r1 = rectList + i;
                    totalNum--;
                    for (j = 0; j < rectNum; j++)
                    {
                        if (computeMark[j] == 0 && p[j] == 0)
                        {
                            r2 = (rectList + j);
                            k = icvSimilarRect(r1, r2);
                            p[j] = k;
                            totalNum += k;
                        }
                    }
                }
            }
        }

        while (computeMark[currentIdx] == 1)
        {
            currentIdx++;
        }

        for (i = 0; i < rectNum; i++)
        {
            if (p[i] == 1)
            {
                buf[i] = classIdx;
                p[i] = 0;
            }
        }
        classIdx++;

    }
    return classIdx;

}

uint32_t icvGrouprectangular(icvRect *rectList, uint32_t rectNum, uint32_t groupThreshold, icvRect *groupResult)
{

    int32_t resultFaceN = 0;
    if (groupThreshold <= 0 || rectNum == 0)
    {
        return resultFaceN;
    }
    void *buf = rectList + rectNum;
    //this is to get the max RIP
    uint8_t *ripHistogram = (uint8_t *)buf;
    memset(ripHistogram, 0, 12 * rectNum);
    buf = (uint8_t *)buf + 12 * rectNum;

    uint32_t *labels = (uint32_t *)buf;
    uint32_t nRecClass = icvMergePartition(rectList, rectNum, labels); //start from 1
    //get average rectangular
    uint32_t i, j;
    uint32_t *rectMergNum = (uint32_t *)buf + rectNum;
    icvRect *rectClass = (icvRect *)(rectMergNum + rectNum);
    for (i = 0; i < nRecClass; i++)
    {
        rectMergNum[i] = 0;
        rectClass[i].topx = 0;
        rectClass[i].topy = 0;
        rectClass[i].width = 0;
        rectClass[i].height = 0;
    }
    for (i = 0; i < rectNum; i++)
    {
        int cnt = labels[i];
        rectClass[cnt].topx += rectList[i].topx;
        rectClass[cnt].topy += rectList[i].topy;
        rectClass[cnt].width += rectList[i].width;
        rectClass[cnt].height += rectList[i].height;
        rectMergNum[cnt]++;
    }

    for (i = 0; i < nRecClass; i++)
    {
        float32_t s = 1.0f / rectMergNum[i];
        rectClass[i].topx = (uint32_t)((rectClass[i].topx * s) + 0.5f);
        rectClass[i].topy = (uint32_t)((rectClass[i].topy * s) + 0.5f);
        rectClass[i].width = (uint32_t)((rectClass[i].width * s) + 0.5f);
        rectClass[i].height = (uint32_t)((rectClass[i].height * s) + 0.5f);
    }
    icvRect *r1, *r2;
    for (i = 0; i < nRecClass; i++)
    {
        r1 = (rectClass + i);
        uint32_t Num1 = rectMergNum[i];
        if (Num1 <= groupThreshold)
        {
            continue;
        }
        // filter out small face rectangles inside large rectangles
        for (j = 0; j < nRecClass; j++)
        {
            r2 = (rectClass + j);
            uint32_t Num2 = rectMergNum[j];
            if (j == i || Num2 <= groupThreshold)
            {
                continue;
            }

            uint32_t dx = (uint32_t)((r2->width * 0.2) + 0.5);
            uint32_t dy = (uint32_t)((r2->height * 0.2) + 0.5);

            if (i != j &&
                    r1->topx >= r2->topx - dx &&
                    r1->topy >= r2->topy - dy &&
                    r1->topx + rectClass[i].width <= r2->topx + r2->width + dx &&
                    r1->topy + rectClass[i].height <= r2->topy + r2->height + dy) //&&
            {
                break;
            }
        }

        if (j == nRecClass)
        {
            groupResult[resultFaceN].topx = rectClass[i].topx;
            groupResult[resultFaceN].topy = rectClass[i].topy;
            groupResult[resultFaceN].width = rectClass[i].width;
            groupResult[resultFaceN].height = rectClass[i].height;
            resultFaceN++;
        }
    }
    return resultFaceN;

}


uint32_t  QuicksortPartition32UwIdx(uint32_t *src, uint32_t *idx, int32_t left, int32_t right, int32_t pivot)
{

    uint32_t *pointer;
    uint32_t pivotValue;
    uint32_t tempValue;
    uint32_t tempIdx;
    int32_t i;
    int32_t storeIndex;
    storeIndex = left;
    pointer = (uint32_t *)src;
    pivotValue = pointer[pivot];

    //Sort Decending
    for (i = left; i < right; i ++)
    {
        if (pointer[i] > pivotValue)
        {
            //swap value and move head the storeindex
            tempValue = pointer[i];
            pointer[i] = pointer[storeIndex];
            pointer[storeIndex] = tempValue;

            tempIdx = idx[i];
            idx[i] = idx[storeIndex];
            idx[storeIndex] = tempIdx;

            storeIndex ++;
        }
    }

    tempValue = pointer[storeIndex];
    pointer[storeIndex] = pointer[right];
    pointer[right] = tempValue;

    tempIdx = idx[storeIndex];
    idx[storeIndex] = idx[right];
    idx[right] = tempIdx;

    // return the store index for the pivot value.
    return storeIndex;
}

void Quicksort32UwIdx(uint32_t *src, uint32_t *idx, int32_t left, int32_t right)
{

    int32_t pivotIndexValue;
    int32_t pivotIndexValueNew;

    if (left < right)
    {
        pivotIndexValue = right;
        pivotIndexValueNew = QuicksortPartition32UwIdx(src, idx, left, right, pivotIndexValue);
        Quicksort32UwIdx(src, idx, left, pivotIndexValueNew - 1);
        Quicksort32UwIdx(src, idx, pivotIndexValueNew + 1, right);
    }

}


uint8_t  QuicksortwIdx(uint32_t *src, uint32_t *idx, uint32_t numItems)
{

    if (numItems <= 1)
    {
        return 0;
    }

    //start to do quick sort recursively:
    Quicksort32UwIdx(src, idx, 0, (numItems - 1));

    return 0;
}

void icvPickFace(uint32_t detFaceNum, uint32_t resultFaceNum, icvRect *buff, cvFacedetectResult *result)
{
    //sort detFaceNum based on size
    uint32_t widArr[1500]; //because can't more than 1500 faces in one image
    uint32_t dstwidIdx[1500];

    uint32_t i, j;
    for (i = 0; i < detFaceNum; i++)
    {
        widArr[i] = buff[i].width * buff[i].height;
        dstwidIdx[i] = i;
    }
    QuicksortwIdx(widArr, dstwidIdx, detFaceNum);

    //pick resultFaceNum face
    for (i = 0; i < resultFaceNum; i++)
    {
        j = dstwidIdx[i];
        result[i].topx = buff[j].topx;
        result[i].topy = buff[j].topy;
        result[i].width = buff[j].width;
        result[i].height = buff[j].height;
    }
}


static int32_t icvRunFeature(ifcvFeature *feature, uint32_t offset, int32_t *confidance, int sumStride, uint32_t x, uint16_t num_n_stages)
{
    /////xTaskHandle th3 = xTaskGetCurrentTaskHandle();
    //unsigned portBASE_TYPE uxHighWaterMark1=uxTaskGetStackHighWaterMark(th3);// 179
    //KUART_Output("-12-");
    int32_t nstages = num_n_stages;//MODEL_N_STAGES;
    int32_t stage;
    int32_t nodeOffset = 0, leafOffset = 0;
    uint32_t internalNodeSize = FACE_MODEL_N_INTRENAL_NODE;
    uint32_t ntrees, week, val;
    const int32_t *internalNode;
    ifcvFeature ff;
    uint16_t test[21];
    uint16_t centerVal;
    uint32_t w;
    const uint16_t *p[16];
    uint32_t pBias;
    for (stage = 0; stage < nstages; stage++)
    {
        ntrees = nStageWeekClassifierCount_[stage];
        *confidance = 0;
        //KUART_Output("-14-");
        for (week = 0; week < ntrees; week++)
        {
            //KUART_Output("-15-");
            ff = feature[nodeOffset];
            w  = featureRectW[nodeOffset];
            //KUART_Output("-15-1-");
            p[0] = ff.p[0];
            p[1] = p[0] + w;
            p[2] = p[1] + w;
            p[3] = p[2] + w;
            //KUART_Output("-15-2-");
            p[4] = ff.p[1];
            p[5] = p[4] + w;
            p[6] = p[5] + w;
            p[7] = p[6] + w;
            pBias = p[4] - p[0];
            p[8] = p[4] + pBias;
            p[9] = p[8] + w;
            p[10] = p[9] + w;
            p[11] = p[10] + w;
            p[12] = p[8] + pBias;
            p[13] = p[12] + w;
            p[14] = p[13] + w;
            p[15] = p[14] + w;


            //KUART_Output("-15-3-");

            //sprintf(str, "%u", p[15][offset]);
            //KUART_Output("p[15][offset]");
            //KUART_Output(str);

            test[0] = p[1][offset] - p[0][offset];// offset = 0; 0 + 0
            //char str[10];
            //sprintf(str, "%u", test[0]);
            //KUART_Output("test[0]");
            //KUART_Output(str);
            //KUART_Output("-15-4-");
            test[1] = p[5][offset] - p[4][offset];// error 0 - 0
            //uint16_t a = p[5][offset];
            //uint16_t b = p[4][offset];
            //KUART_Output("-16-");
            //int c = a + b;



            //test[1] = c;
            //KUART_Output("-16-1-");
            test[2] = p[9][offset] - p[8][offset];
            //KUART_Output("-16-1-1-");

            test[3] = p[13][offset] - p[12][offset];
            test[4] = p[2][offset] - p[1][offset];
            test[5] = p[6][offset] - p[5][offset];
            test[6] = p[10][offset] - p[9][offset];
            test[7] = p[14][offset] - p[13][offset];
            test[8]  = p[3][offset] - p[2][offset];
            test[9]  = p[7][offset] - p[6][offset];
            test[10] = p[11][offset] - p[10][offset];
            test[11] = p[15][offset] - p[14][offset];
            //KUART_Output("-16-2-");
            centerVal = test[6] - test[5] - 1;
            test[12] = test[1] - test[0];
            test[13] = test[5] - test[4];
            test[14] = test[9] - test[8] ;
            test[15] = test[10] - test[9];
            test[16] = test[11] - test[10];
            test[17] = test[7] - test[6];
            test[18] = test[3] - test[2];
            test[19] = test[2] - test[1];
            //KUART_Output("-16-3-");
            val = (test[12] > centerVal ? 128 : 0) |
                  (test[13] > centerVal ? 64 : 0) |
                  (test[14] > centerVal ? 32 : 0) |
                  (test[15] > centerVal ? 16 : 0) |
                  (test[16] > centerVal ? 8 : 0) |
                  (test[17] > centerVal ? 4 : 0) |
                  (test[18] > centerVal ? 2 : 0) |
                  (test[19] > centerVal ? 1 : 0);
            //KUART_Output("-16-4-");
            internalNode = &cascadeInternalNodeValues_[nodeOffset * internalNodeSize];
            //KUART_Output("-17-");
            *confidance += cascadeLeaves_[internalNode[val >> 5] & (1 << (val & 31)) ? leafOffset : leafOffset + 1];
            nodeOffset += 1;
            leafOffset += 2;
            //KUART_Output("-18-");
        }

        if (*confidance < stageThreshold[stage])
        {
            return -stage;
        }
    }

    return 1;
}


uint32_t icvObjectDetection(uint8_t *__restrict src,
                            uint32_t srcWidth,
                            uint32_t srcHeight,
                            uint32_t srcStride,
                            cvFacedetectParameters *para,
                            uint32_t maxDetectedFaceNum,
                            uint32_t *resultFaceNum,
                            cvFacedetectResult *result,
                            void *buffer_2)
{

    //KUART_Output("<begin icvObjectDetection>");
    uint32_t x, y, fi, offset, minFaceSize, maxFaceSizeWidth, maxFaceSizeHeight, fX, fY, fH, stepSize;
    uint32_t nCandidate, scaleImgStride;
    int32_t sumStride;
    float32_t sFactor;
    uint8_t *scaleImg = NULL, *srcHisteq = NULL;
    const uint16_t *ptr;
    uint16_t *sum;
    void *buf = buffer_2;
    icvRect *candidateResult = NULL;
    ifcvFeature *feature = NULL;
    int32_t resultRunFearure, processingRectSizeWidth, processingRectSizeHeight;
    uint32_t windowSizeWidth, windowSizeHeight, scaleImgWidth, scaleImgHeight;
    int32_t confidance;
    icvRect cf;
    //  uint32_t minNeighbors = DEFAULT_MIN_NEIGHBOR;

    minFaceSize = CV_MAX(FACE_MODEL_X_SIZE, para->minSize);
    if (para->maxSize == 0)
    {
        maxFaceSizeWidth = srcWidth;
        maxFaceSizeHeight = srcHeight;
    }
    else
    {
        maxFaceSizeWidth = para->maxSize;
        maxFaceSizeHeight = para->maxSize;
    }

    stepSize = para->stepSize;

    //define the candidate buffer_2 first. so that rest of the buffer_2 can be reused in group rectangle
    candidateResult = (icvRect *)buf;
    buf = (uint8_t *)buf + maxDetectedFaceNum * FACE_MAX_CANDIDATE_RECT * sizeof(icvRect);

    srcHisteq = (uint8_t *)buf;
    buf = (uint8_t *)buf + srcStride * srcHeight * sizeof(uint8_t) + 16; //for 128 bit alignemnt
    srcHisteq = (uint8_t *)((size_t)srcHisteq + (16 - (size_t)srcHisteq % 16));

    //xTaskHandle hdl2 = xTaskGetCurrentTaskHandle();
    //unsigned portBASE_TYPE uxHighWaterMark2=uxTaskGetStackHighWaterMark( hdl2 );
    icvhistogramEqualizeImage(src, srcWidth, srcHeight, srcStride, srcHisteq);
    //KUART_Output("-6-");
    feature = (ifcvFeature *)buf;
    buf = (uint8_t *)buf + FACE_MODEL_N_FEATURE * sizeof(ifcvFeature);

    nCandidate = 0;
    for (sFactor = 1.f; ; sFactor *= scaleFactor)
    {
        windowSizeWidth = (uint32_t)((FACE_MODEL_X_SIZE * sFactor) + 0.5f);
        windowSizeHeight = (uint32_t)((FACE_MODEL_Y_SIZE * sFactor) + 0.5f);
        scaleImgWidth = (uint32_t)((srcWidth * (1 / sFactor)) + 0.5f);
        scaleImgHeight = (uint32_t)((srcHeight * (1 / sFactor)) + 0.5f);
        processingRectSizeWidth = scaleImgWidth - FACE_MODEL_X_SIZE ;
        processingRectSizeHeight = scaleImgHeight - FACE_MODEL_Y_SIZE;

        if (processingRectSizeWidth <= 0 || processingRectSizeHeight <= 0)
        {
            break;
        }
        if (windowSizeWidth > maxFaceSizeWidth || windowSizeHeight > maxFaceSizeHeight)
        {
            break;
        }
        if (windowSizeWidth < minFaceSize || windowSizeHeight < minFaceSize)
        {
            continue;
        }
        scaleImg = (uint8_t *)buf;
        scaleImgStride = scaleImgWidth;
        buf = (uint8_t *)buf + scaleImgStride * scaleImgHeight * sizeof(uint8_t) + 16; //128 bit aligned
        scaleImg = (uint8_t *)((size_t)scaleImg + (16 - (size_t)scaleImg % 16));

        if (sFactor != 1.f)
        {
            cvScaleDown(srcHisteq, srcWidth, srcHeight, srcStride, scaleImg, scaleImgWidth, scaleImgHeight, scaleImgStride);
        }
        else
        {
            scaleImgStride = srcStride;
            memcpy(scaleImg, srcHisteq, (scaleImgStride * scaleImgHeight));
        }

        //16 bit integral image = > only LSB 16 is required for FD
        sumStride = (scaleImgWidth + 1) * sizeof(uint16_t);
        sumStride = (sumStride + 16 - 1) & -16;
        sum = (uint16_t *)buf;
        buf = (uint8_t *)buf + sumStride * (scaleImgHeight + 1) + 16; //128 bit aligned
        sum = (uint16_t *)((size_t)sum + (16 - (size_t)sum % 16));
        cvIntegrateImage(scaleImg, scaleImgWidth, scaleImgHeight, scaleImgStride, sum, sumStride);

        sumStride =  sumStride / sizeof(uint16_t);

        for (fi = 0; fi < FACE_MODEL_N_FEATURE; fi++)
        {
            ptr = (uint16_t *)sum;
            fX = featureRectX[fi];
            fY = featureRectY[fi];
            fH = featureRectH[fi];
            //2 pointer feature

            feature[fi].p[0] = ptr + fX + (sumStride * fY);
            uint16_t a = sumStride * fH;

            feature[fi].p[1] = feature[fi].p[0] + a;
            // feature[fi].p[1] = feature[fi].p[0]+ sumStride*fH;// 0x2001B938 + 328 * 4 = 1312

        }

        stepSize = sFactor > 2.f ? 1 : stepSize;// stepSize = 2
        //  foundCandidate = 0;
        for (y = 0; y < (uint32_t)processingRectSizeHeight; y += stepSize)
        {
            for (x = 0; x < (uint32_t)processingRectSizeWidth; x += stepSize)
            {
                offset = y * (sumStride) + x;// sumStride = 168

                resultRunFearure = icvRunFeature(feature, offset, &confidance, sumStride, x, FACE_MODEL_N_STAGES);// resultRunFeature = -1;
                if (resultRunFearure > 0)
                {
                    cf.topx = (uint32_t)((x * sFactor) + 0.5f);
                    cf.topy = (uint32_t)((y * sFactor) + 0.5f);
                    cf.width = windowSizeWidth;
                    cf.height = windowSizeHeight;
                    candidateResult[nCandidate++] = cf;
                    //foundCandidate = 1;
                }
                else if (resultRunFearure == 0)
                {
                    x += stepSize;
                }
            }
        }
        buf = (uint8_t *)buf - sumStride * (scaleImgHeight + 1) * sizeof(uint16_t)  - 16;
        buf = (uint8_t *)buf - scaleImgWidth * scaleImgHeight * sizeof(uint8_t) - 16;
    }

    //KUART_Output("<5>");

    feature = NULL;

    icvRect *buff = (icvRect *)buffer_2;
    uint32_t detFaceNum = icvGrouprectangular(candidateResult, nCandidate, minNeighbors, buff);
    //KUART_Output("<6>");
    if (detFaceNum <= maxDetectedFaceNum)
    {
        *resultFaceNum = detFaceNum;
        uint32_t i = 0;
        for (; i < detFaceNum; i++)
        {
            result[i].topx = buff[i].topx;
            result[i].topy = buff[i].topy;
            result[i].height = buff[i].height;
            result[i].width = buff[i].width;
            //  result[i].curr_time_stamp = curr_stamp;
        }
    }
    else
    {
        //pick up the most largest face
        icvPickFace(detFaceNum, maxDetectedFaceNum, buff, result);
        *resultFaceNum = maxDetectedFaceNum;
    }
    //KUART_Output("<end icvObjectDetection>");
    return 1;
}



static uint32_t histogram[256];
void icvhistogramEqualizeImage(const uint8_t *__restrict src, uint32_t srcWidth, uint32_t srcHeight, uint32_t srcStride, uint8_t *__restrict dst)
{
    //  KUART_Output("<begin icvhistogramEqualizeImage>");
    uint32_t i, j;
    //uint32_t histogram[256];
    const uint8_t *ptr;
    uint8_t *ptr_;
    float32_t fConversion;
    //KUART_Output("-1-");
    memset(histogram, 0, (256 * sizeof(uint32_t)));
    //KUART_Output("-2-");
    for (i = 0 ; i < srcHeight; i++)
    {
        ptr = src + i * srcStride;
        for (j = 0 ; j < srcWidth; j++)
        {
            histogram[(int32_t)(ptr[j])] += 1;
        }
    }
    for (i = 1 ; i < 256 ; i++)
    {
        histogram[i] += histogram[i - 1];

    }
    fConversion = 255.0f / (1.0f * histogram[255]);
    for (i = 0 ; i < srcHeight; i++)
    {
        //char str[10];
        //sprintf(str,"%u", i);
        //KUART_Output(str);
        //sprintf(str,"%u", srcHeight);
        //KUART_Output("srcHeight");
        //KUART_Output(str);
        ptr = src + i * srcStride;
        ptr_ = dst + i * srcStride;
        for (j = 0 ; j < srcWidth; j++)
        {
            ptr_[j] = (uint8_t)(((fConversion * histogram[(uint32_t)(ptr[j])])) + 0.5f);
        }
    }
}

void cvIntegrateImage(const uint8_t *__restrict src,
                      unsigned int srcWidth,
                      unsigned int srcHeight,
                      unsigned int srcStride,
                      uint16_t *__restrict dst,
                      unsigned int dstStride)
{
    unsigned int i, j;
    unsigned int sum;
    uint16_t *iimg;
    uint16_t *iimgPrev;
    const uint8_t *img;

    dstStride = (dstStride / sizeof(uint16_t));     //Convert from #bytes to #values

    // first pxlC015
    img      = src;
    iimgPrev = dst;
    iimg     = dst + dstStride;
    *iimg++ = *iimgPrev++ = sum = 0;  // zero first column

    for (j = 0; j < srcWidth; ++j)
    {
        iimgPrev[j] = 0;
        sum    += img[j];
        iimg[j] = (uint16_t)sum;
    }

    // remaining rows
    iimgPrev = iimg;
    img  += srcStride;
    iimg += dstStride;

    for (i = 1; i < srcHeight; ++i)
    {
        iimg[-1] = sum = 0;  // zero first column

        for (j = 0; j < srcWidth; ++j)
        {
            sum    += img[j];
            iimg[j] = (uint16_t)(sum + iimgPrev[j]);
        }
        iimgPrev = iimg;
        img     += srcStride;
        iimg    += dstStride;
    }
}


#define MN_DIV_Q_BITS            32
static const uint32_t mn_div_table[401] =
{
    4294967295, 4294967295, 2147483648, 1431655766, 1073741824, 858993460, 715827883, 613566757, 536870912, 477218589, 429496730, 390451573, 357913942, 330382100,
    306783379, 286331154, 268435456, 252645136, 238609295, 226050911, 214748365, 204522253, 195225787, 186737709, 178956971, 171798692, 165191050, 159072863,
    153391690, 148102321, 143165577, 138547333, 134217728, 130150525, 126322568, 122713352, 119304648, 116080198, 113025456, 110127367, 107374183, 104755300,
    102261127, 99882961, 97612894, 95443718, 93368855, 91382283, 89478486, 87652394, 85899346, 84215046, 82595525, 81037119, 79536432, 78090315, 76695845, 75350304,
    74051161, 72796056, 71582789, 70409300, 69273667, 68174085, 67108864, 66076420, 65075263, 64103990, 63161284, 62245903, 61356676, 60492498, 59652324, 58835169,
    58040099, 57266231, 56512728, 55778797, 55063684, 54366675, 53687092, 53024288, 52377650, 51746594, 51130564, 50529028, 49941481, 49367441, 48806447, 48258060,
    47721859, 47197443, 46684428, 46182445, 45691142, 45210183, 44739243, 44278014, 43826197, 43383509, 42949673, 42524429, 42107523, 41698712, 41297763, 40904451,
    40518560, 40139882, 39768216, 39403370, 39045158, 38693400, 38347923, 38008561, 37675152, 37347542, 37025581, 36709123, 36398028, 36092163, 35791395, 35495598,
    35204650, 34918434, 34636834, 34359739, 34087043, 33818641, 33554432, 33294321, 33038210, 32786010, 32537632, 32292988, 32051995, 31814573, 31580642, 31350127,
    31122952, 30899046, 30678338, 30460761, 30246249, 30034737, 29826162, 29620465, 29417585, 29217465, 29020050, 28825284, 28633116, 28443493, 28256364, 28071682,
    27889399, 27709467, 27531842, 27356480, 27183338, 27012373, 26843546, 26676816, 26512144, 26349493, 26188825, 26030105, 25873297, 25718368, 25565282, 25414008,
    25264514, 25116768, 24970741, 24826401, 24683721, 24542671, 24403224, 24265352, 24129030, 23994231, 23860930, 23729102, 23598722, 23469767, 23342214, 23216040,
    23091223, 22967740, 22845571, 22724695, 22605092, 22486740, 22369622, 22253717, 22139007, 22025474, 21913099, 21801865, 21691755, 21582751, 21474837, 21367997,
    21262215, 21157475, 21053762, 20951060, 20849356, 20748635, 20648882, 20550083, 20452226, 20355296, 20259280, 20164166, 20069941, 19976593, 19884108, 19792477,
    19701685, 19611723, 19522579, 19434242, 19346700, 19259944, 19173962, 19088744, 19004281, 18920561, 18837576, 18755316, 18673771, 18592933, 18512791, 18433337,
    18354562, 18276457, 18199014, 18122225, 18046082, 17970575, 17895698, 17821442, 17747799, 17674763, 17602325, 17530479, 17459217, 17388532, 17318417, 17248865,
    17179870, 17111424, 17043522, 16976156, 16909321, 16843010, 16777216, 16711936, 16647161, 16582886, 16519105, 16455814, 16393005, 16330675, 16268816, 16207424,
    16146494, 16086020, 16025998, 15966422, 15907287, 15848588, 15790321, 15732481, 15675064, 15618063, 15561476, 15505298, 15449523, 15394149, 15339169, 15284582,
    15230381, 15176563, 15123125, 15070061, 15017369, 14965043, 14913081, 14861479, 14810233, 14759338, 14708793, 14658592, 14608733, 14559212, 14510025, 14461170,
    14412642, 14364440, 14316558, 14268995, 14221747, 14174810, 14128182, 14081860, 14035841, 13990122, 13944700, 13899571, 13854734, 13810185, 13765921, 13721941,
    13678240, 13634817, 13591669, 13548793, 13506187, 13463848, 13421773, 13379961, 13338408, 13297113, 13256072, 13215284, 13174747, 13134457, 13094413, 13054612,
    13015053, 12975733, 12936649, 12897800, 12859184, 12820798, 12782641, 12744711, 12707004, 12669521, 12632257, 12595213, 12558384, 12521771, 12485371, 12449181,
    12413201, 12377428, 12341861, 12306497, 12271336, 12236375, 12201612, 12167047, 12132676, 12098500, 12064515, 12030721, 11997116, 11963698, 11930465, 11897417,
    11864551, 11831866, 11799361, 11767034, 11734884, 11702909, 11671107, 11639478, 11608020, 11576732, 11545612, 11514658, 11483870, 11453247, 11422786, 11392487,
    11362348, 11332368, 11302546, 11272881, 11243370, 11214014, 11184811, 11155760, 11126859, 11098107, 11069504, 11041048, 11012737, 10984572, 10956550, 10928670,
    10900933, 10873335, 10845878, 10818558, 10791376, 10764330, 10737419

};

void cvScaleDown(const uint8_t *__restrict src,
                 uint32_t                  srcWidth,
                 uint32_t                  srcHeight,
                 uint32_t                  srcStride,
                 uint8_t *__restrict       dst,
                 uint32_t                  dstWidth,
                 uint32_t                  dstHeight,
                 uint32_t                  dstStride)
{
    if (!(src && dst && srcWidth && srcHeight && dstWidth && dstHeight &&
            (srcStride == 0 || srcStride >= srcWidth) && (dstStride == 0 || dstStride >= dstWidth)))
    {
        return; //error
    }

    srcStride   = (srcStride  == 0) ? (srcWidth)  : srcStride;
    dstStride   = (dstStride  == 0) ? (dstWidth)  : dstStride;

    if (dstWidth * 20 < srcWidth || dstHeight * 20 < srcHeight)
    {
        return;
    }

    // per output column, number of input columns to use
    // for accumulating rows together before averaging
    const int raw_buf_size = 2 * srcWidth * sizeof(uint16_t) + dstWidth + (4 * 32);
    uint8_t *raw_buf = (uint8_t *)malloc_ext(0, raw_buf_size);
    if (!raw_buf)
    {
        return;
    }


    uint8_t *horiz_input_pixels = (uint8_t *)(((uint32_t)raw_buf + 31) & ~31);
    uint16_t *raster = (uint16_t *)(horiz_input_pixels + ((dstWidth + 31) & ~31));
    //uint16_t *raster2 = (uint16_t *)(((uint32_t)(&raster[srcWidth]) + 31) & ~31);

    uint32_t count = 0;
    uint8_t step  = 0;
    uint8_t *p_step = horiz_input_pixels;

    // pre-compute how many src columns are averaged for each dst column.
    uint32_t i = 0;
    uint32_t j = 0;
    for (; i < srcWidth; i++)
    {
        count += dstWidth;        // M
        step++;

        if (count >= srcWidth)     // N
        {
            *p_step++ = step;
            count -= srcWidth;
            step = 0;
        }
    }

    count = 0;
    step  = 0;
    uint32_t accum = 0;

    // compute how many src rows are averaged for each dst row. During loop, perform averaging and write output pixels.
    for (i = 0; i < dstHeight; i++)
    {
        // for new dst rows, reset raster values to next src row.
        for (j = 0; j < srcWidth; j++)
        {
            raster[j] = src[j];
        }
        count += dstHeight;        // M
        step++;
        src += srcStride;
        while (count < srcHeight)
        {
            // add next src row to raster values.
            for (j = 0; j < srcWidth; j++)
            {
                raster[j] += src[j];
            }
            count += dstHeight;        // M
            step++;
            src += srcStride;
        }

        // accumulate columns out output a row of pixels.
        uint16_t *p_raster = raster;
        uint32_t k = 1;
        for (j = 0; j < dstWidth; j++)
        {
            // accumulate the appropriate number of column sums, divide by number of source pixels used, and output pixel
            accum = *p_raster++;
            for (k = 1; k < horiz_input_pixels[j]; k++)
            {
                accum += *p_raster++;
            }
            // source pixels contributing to accum are step rows * horiz_input_pixels[j] columns.
            dst[j] = (uint8_t)(((uint64_t)accum * mn_div_table[step * horiz_input_pixels[j]]) >> MN_DIV_Q_BITS);
        }
        count -= srcHeight;
        step = 0;
        dst += dstStride;
    }
    free_ext(0, raw_buf);
}


