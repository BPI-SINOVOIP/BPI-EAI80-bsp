#include<gm_soc.h>

/* Includes ------------------------------------------------------------------*/
#include<gm_hal_iwdg.h>
#include"gm_ll_iwdg.h"



/** @addtogroup IWDG
  * @brief IWDG HAL module driver.
  * @{
  */

/* Private typedef -----------------------------------------------------------*/
/* Private define ------------------------------------------------------------*/
/** @defgroup IWDG_Private_Defines IWDG Private Defines
  * @{
  */
/* Status register need 5 RC LSI divided by prescaler clock to be updated. With
   higher prescaler (256), and according to HSI variation, we need to wait at
   least 6 cycles so 48 ms. */
#define HAL_IWDG_DEFAULT_TIMEOUT            48U
/**
  * @}
  */

/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
/* Private function prototypes -----------------------------------------------*/
/* Exported functions --------------------------------------------------------*/

/** @addtogroup IWDG_Exported_Functions
  * @{
  */

/** @addtogroup IWDG_Exported_Functions_Group1
  *  @brief    Initialization and Start functions.
  *
@verbatim
 ===============================================================================
          ##### Initialization and Start functions #####
 ===============================================================================
 [..]  This section provides functions allowing to:
      (+) Initialize the IWDG according to the specified parameters in the
          IWDG_InitTypeDef of associated handle.
      (+) Once initialization is performed in HAL_IWDG_Init function, Watchdog
          is reloaded in order to exit function with correct time base.

@endverbatim
  * @{
  */

/**
  * @brief  Initialize the IWDG according to the specified parameters in the
  *         IWDG_InitTypeDef and start watchdog. Before exiting function,
  *         watchdog is refreshed in order to have correct time base.
  * @param  hiwdg  pointer to a IWDG_HandleTypeDef structure that contains
  *                the configuration information for the specified IWDG module.
  * @retval HAL status
  */
RET_CODE HAL_IWDG_Init(IWDG_HandleTypeDef *hiwdg)
{
    uint32_t tickstart;

    /* Check the IWDG handle allocation */
    if (hiwdg == NULL)
    {
        return RET_ERROR;
    }

    /* Check the parameters */
    assert_param(IS_IWDG_ALL_INSTANCE(hiwdg->Instance));
    assert_param(IS_IWDG_PRESCALER(hiwdg->Init.Prescaler));
    assert_param(IS_IWDG_RELOAD(hiwdg->Init.Reload));

    /* Enable IWDG. LSI is turned on automaticaly */
    __HAL_IWDG_START(hiwdg);

    /* Enable write access to IWDG_PR and IWDG_RLR registers by writing 0x5555 in KR */
    IWDG_ENABLE_WRITE_ACCESS(hiwdg);

    /* Write to IWDG registers the Prescaler & Reload values to work with */
    hiwdg->Instance->PR = hiwdg->Init.Prescaler;
    hiwdg->Instance->RLR = hiwdg->Init.Reload;

    /* Check pending flag, if previous update not done, return timeout */
    tickstart = HAL_GetTick();

    /* Wait for register to be updated */
    while (hiwdg->Instance->SR != RESET)
    {
        if ((HAL_GetTick() - tickstart) > HAL_IWDG_DEFAULT_TIMEOUT)
        {
            return RET_TIMEOUT;
        }
    }

    /* Reload IWDG counter with value defined in the reload register */
    __HAL_IWDG_RELOAD_COUNTER(hiwdg);

    /* Return function status */
    return RET_OK;
}

/**
  * @}
  */

/** @addtogroup IWDG_Exported_Functions_Group2
  *  @brief   IO operation functions
  *
@verbatim
 ===============================================================================
                      ##### IO operation functions #####
 ===============================================================================
 [..]  This section provides functions allowing to:
      (+) Refresh the IWDG.

@endverbatim
  * @{
  */

/**
  * @brief  Refresh the IWDG.
  * @param  hiwdg  pointer to a IWDG_HandleTypeDef structure that contains
  *                the configuration information for the specified IWDG module.
  * @retval HAL status
  */
RET_CODE HAL_IWDG_Refresh(IWDG_HandleTypeDef *hiwdg)
{
    /* Reload IWDG counter with value defined in the reload register */
    __HAL_IWDG_RELOAD_COUNTER(hiwdg);

    /* Return function status */
    return RET_OK;
}

/**
  * @}
  */




