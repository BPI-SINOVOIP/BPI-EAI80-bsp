
#include <time.h>
#include <math.h>

#include <obj_info.h>

#define PI         3.14159

static len_t   g_camera_height;//in mm
static angle_t g_camera_angle;//in rad
static len_t   g_camera_focus;//in pixel
static len_t   g_pic_width;//in pixel
static len_t   g_pic_height;//in pixel


/* set position param of camera, this info can get by engineer who' in charge of fixing the camera */
int obj_info_set_camera_param(camera_position_param_t camera_position_param)
{
    g_camera_height = camera_position_param.height_to_ground;
    g_camera_angle = camera_position_param.angle_to_ground;
    g_camera_focus = camera_position_param.focal_len;
    g_pic_width = camera_position_param.pic_width;
    g_pic_height = camera_position_param.pic_height;

    return 0;
}

angle_t angle_test = 0;
static obj_info_t get_obj_info_lower(len_t foot_x, len_t foot_y, len_t head_x, len_t head_y, angle_t Angle_AcBcAg, len_t Len_OcBc)
{
    /* change to pic axis */
    len_t Foot_X = foot_x - (len_t)g_pic_width/2.0;
    len_t Foot_Y = (len_t)g_pic_height/2.0 - foot_y;
    len_t Head_X = head_x - (len_t)g_pic_width/2.0;
    len_t Head_Y = (len_t)g_pic_height/2.0 - head_y;
    
    len_t Len_OcO = g_camera_focus;
    len_t Len_PyO = fabs(Foot_Y);
    len_t Len_PxO = fabs(Foot_X);
    len_t Len_BcQc = Len_OcO / Len_PyO * Len_OcBc;
    len_t Len_QcOc = sqrt(Len_BcQc * Len_BcQc + Len_OcBc * Len_OcBc);
    len_t Len_PyOc = sqrt(Len_OcO * Len_OcO + Len_PyO * Len_PyO);
    len_t Len_PcQc = Len_PxO / Len_PyOc * Len_QcOc;

    angle_t Angle_BcQcQg = atan(Len_OcBc / Len_BcQc);
	angle_test = Angle_BcQcQg;
    angle_t Angle_BcQgQc = PI - Angle_BcQcQg - Angle_AcBcAg;
    len_t Len_QgQc = Len_BcQc * (sin(Angle_AcBcAg) / sin(Angle_BcQgQc));
    len_t Len_PgQg = (Len_QcOc - Len_QgQc) / Len_QcOc * Len_PcQc;
    len_t Len_BcQg = sin(Angle_BcQcQg) / sin(Angle_BcQgQc) * Len_BcQc;

#if 1//angle in ground plane
    angle_t Angle_PgBcQg = atan(Len_PgQg / Len_BcQg) * (180.0 / PI);
#else//angle in optic axis plane
    angle_t Angle_PgBcQg = atan(Len_PxO / Len_PyOc) * (180.0 / PI);
#endif

    obj_info_t person_info;
    person_info.x = (Foot_X < 0) ? Len_PgQg : -Len_PgQg;
    person_info.z = Len_BcQg;
    person_info.h = 0;
    person_info.angle = (Foot_X < 0) ? (90.0 - Angle_PgBcQg) : (90.0 + Angle_PgBcQg);

    return person_info;
}

static obj_info_t get_person_info_higher(len_t foot_x, len_t foot_y, len_t head_x, len_t head_y, angle_t Angle_AcBcAg, len_t Len_OcBc)
{
    /* change to pic axis */
    len_t Foot_X = foot_x - (len_t)g_pic_width/2.0;
    len_t Foot_Y = (len_t)g_pic_height/2.0 - foot_y;
    len_t Head_X = head_x - (len_t)g_pic_width/2.0;
    len_t Head_Y = (len_t)g_pic_height/2.0 - head_y;

    len_t Len_OcO = g_camera_focus;
    len_t Len_PyO = fabs(Foot_Y);
    len_t Len_PxO = fabs(Foot_X);

    angle_t Angle_OOcPy = atan(Len_PyO / Len_OcO);
    angle_t Angle_BcOcPy = Angle_OOcPy + PI / 2.0;
    angle_t Angle_OcBcQg = PI / 2.0 - Angle_AcBcAg;
    angle_t Angle_BcQgOc = PI - Angle_BcOcPy - Angle_OcBcQg;
    len_t Len_BcQg = sin(Angle_BcOcPy) / sin(Angle_BcQgOc) * Len_OcBc;

    len_t Len_OcQg = sin(Angle_OcBcQg) / sin(Angle_BcQgOc) * Len_OcBc;
    len_t Len_OcPy = sqrt(Len_OcO * Len_OcO + Len_PyO * Len_PyO);
    len_t Len_PgQg = Len_PxO / Len_OcPy * Len_OcQg;

#if 1//angle in ground plane
    angle_t Angle_PgBcQg = atan(Len_PgQg / Len_BcQg) * (180.0 / PI);
#else//angle in optic axis plane
    angle_t Angle_PgBcQg = atan(Len_PxO / Len_OcPy) * (180.0 / PI);
#endif

    obj_info_t person_info;
    person_info.x = (Foot_X < 0) ? Len_PgQg : -Len_PgQg;
    person_info.z = Len_BcQg;
    person_info.h = 0;
    person_info.angle = (Foot_X < 0) ? (90.0 - Angle_PgBcQg) : (90.0 + Angle_PgBcQg);

    return person_info;
}

/*
assume that the optic axis is not parallel to the ground
input: foot_x, foot_y, head_x, head_y is in pixel cordinary(pixel unit)
output: obj_info_t is in camera cordinary(cm unit)
get_obj_info_lower(): the foot is lower than the optic axis
get_person_info_higher(): the foot is higher than the optic axis
*/
obj_info_t obj_info_get(len_t foot_x, len_t foot_y, len_t head_x, len_t head_y)
{
    static angle_t Angle_AcBcAg;
    static len_t Len_OcBc;
    static int init_flag = 0;

    Angle_AcBcAg = g_camera_angle;
    Len_OcBc = g_camera_height;
    
    obj_info_t person_info;
    if(foot_y > (len_t)g_pic_height/2.0)
    {
        person_info = get_obj_info_lower(foot_x, foot_y, head_x, head_y, Angle_AcBcAg, Len_OcBc);
    }
    else
    {
        person_info = get_person_info_higher(foot_x, foot_y, head_x, head_y, Angle_AcBcAg, Len_OcBc);
    }

    return person_info;
}



/********************************************************************
 * get person position by grid(only return x,z,angle)
 ********************************************************************/
#if 0
#define PIC_W       224
#define PIC_H       224
#define GRID_SIZE   20
/* 
 * test by condition:
 * height_to_ground = 233;
 * angle_to_ground = 0.7853981633974483;//45
 * focal_len = 117.2;
 * pic_width = 224;
 * pic_height = 224;
 */
#define INFO_GRID_DEFAULT_HEIGHT 233 
obj_info_t info_grid[PIC_H/GRID_SIZE][PIC_W/GRID_SIZE] = 
{
/*      0           20          40          60          80      100         120       140     160         180       200 */
/* 0*/ {{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
/*20*/ {{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
/*40*/ {{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
/*60*/ {{300,350,1,0},{250,350,1,0},{200,350,1,0},{120,350,1,0},{50 ,350,1,0},{0  ,350,1,0},{-50 ,350,1,0},{-100,350,1,0},{-180,350,1,0},{-240,350,1,0},{-300,350,1,0}},
/*80*/ {{300,300,1,0},{200,300,1,0},{150,300,1,0},{100,300,1,0},{50 ,300,1,0},{0  ,300,1,0},{-40 ,300,1,0},{-100,300,1,0},{-150,300,1,0},{-200,300,1,0},{-300,300,1,0}},
/*100*/{{300,250,1,0},{200,250,1,0},{150,250,1,0},{100,250,1,0},{50 ,250,1,0},{0  ,250,1,0},{-30 ,250,1,0},{-90 ,250,1,0},{-130,250,1,0},{-200,250,1,0},{-300,250,1,0}},
/*120*/{{250,200,1,0},{200,200,1,0},{150,200,1,0},{100,200,1,0},{50 ,200,1,0},{0  ,200,1,0},{-20 ,200,1,0},{-90 ,200,1,0},{-110,200,1,0},{-180,200,1,0},{-250,200,1,0}},
/*140*/{{250,150,1,0},{175,150,1,0},{125,150,1,0},{80 ,150,1,0},{50 ,150,1,0},{0  ,150,1,0},{-20 ,150,1,0},{-80 ,150,1,0},{-100,150,1,0},{-170,150,1,0},{-230,150,1,0}},
/*160*/{{250,125,1,0},{160,125,1,0},{125,125,1,0},{80 ,125,1,0},{50 ,125,1,0},{0  ,125,1,0},{-20 ,130,1,0},{-70 ,120,1,0},{-100,110,1,0},{-150,100,1,0},{-210,100,1,0}},
/*180*/{{200,100,1,0},{150,100,1,0},{100,100,1,0},{80 ,100,1,0},{50 ,100,1,0},{0  ,100,1,0},{-20 ,100,1,0},{-60 ,90 ,1,0},{-90 ,80 ,1,0},{-120,70 ,1,0},{-200,60 ,1,0}},
/*200*/{{200,50 ,1,0},{150,50 ,1,0},{100,50 ,1,0},{80 ,50 ,1,0},{50 ,50 ,1, 0},{0  ,50 ,1,0},{-10 ,30 ,1,0},{-50 ,30 ,1,0},{-90 ,20 ,1,0},{-120,10 ,1,0},{-180,10 ,1,0}},
};
#else
#define PIC_W       224
#define PIC_H       224
#define GRID_SIZE   10
/* 
 * test by condition:
 * height_to_ground = 233;
 * angle_to_ground = 0.7853981633974483;//45
 * focal_len = 212;
 * pic_width = 224;
 * pic_height = 224;
 */
#define INFO_GRID_DEFAULT_HEIGHT 233 
obj_info_t info_grid[PIC_H/GRID_SIZE][PIC_W/GRID_SIZE] = 
{
/*      0               10              20          30          40              50              60              70          80              90              100         110         120             130             140             150             160         170             180             190         200             210                  */
/*00*/  {{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
/*01*/  {{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
/*02*/  {{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
/*03*/  {{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
/*04*/  {{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
/*05*/  {{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}},
/*60*/  {{330,400,1,0},{300,400,1,0},{270,400,1,0},{240,400,1,0},{200,400,1,0},{170,400,1,0},{130,400,1,0},{100,400,1,0},{ 80,400,1,0},{ 50,400,1,0},{ 0,400,1,0},{  0,400,1,0},{ -50,400,1,0},{ -80,400,1,0},{-100,400,1,0},{-130,400,1,0},{-170,400,1,0},{-200,400,1,0},{-240,400,1,0},{-270,400,1,0},{-300,400,1,0},{-330,400,1,0}},
/*70*/  {{320,350,1,0},{300,350,1,0},{260,350,1,0},{220,350,1,0},{200,350,1,0},{170,350,1,0},{130,350,1,0},{100,350,1,0},{ 70,350,1,0},{ 40,350,1,0},{ 0,350,1,0},{  0,350,1,0},{ -40,350,1,0},{ -70,350,1,0},{-100,350,1,0},{-130,350,1,0},{-170,350,1,0},{-200,350,1,0},{-220,350,1,0},{-260,350,1,0},{-300,350,1,0},{-320,350,1,0}},
/*80*/  {{320,300,1,0},{300,300,1,0},{250,300,1,0},{220,300,1,0},{200,300,1,0},{160,300,1,0},{120,300,1,0},{100,300,1,0},{ 60,300,1,0},{ 40,300,1,0},{ 0,300,1,0},{  0,300,1,0},{ -40,300,1,0},{ -60,300,1,0},{-100,300,1,0},{-120,300,1,0},{-160,300,1,0},{-200,300,1,0},{-220,300,1,0},{-250,300,1,0},{-300,300,1,0},{-320,300,1,0}},
/*90*/  {{320,280,1,0},{300,280,1,0},{250,280,1,0},{200,280,1,0},{180,280,1,0},{150,280,1,0},{110,280,1,0},{ 90,280,1,0},{ 60,280,1,0},{ 40,280,1,0},{ 0,280,1,0},{  0,280,1,0},{ -40,280,1,0},{ -60,280,1,0},{ -90,280,1,0},{-110,280,1,0},{-150,280,1,0},{-180,280,1,0},{-200,280,1,0},{-250,280,1,0},{-300,280,1,0},{-320,280,1,0}},
/*100*/ {{300,250,1,0},{280,250,1,0},{220,250,1,0},{200,250,1,0},{180,250,1,0},{150,250,1,0},{110,250,1,0},{ 80,250,1,0},{ 60,250,1,0},{ 40,250,1,0},{ 0,250,1,0},{  0,250,1,0},{ -40,250,1,0},{ -60,250,1,0},{ -80,250,1,0},{-110,250,1,0},{-150,250,1,0},{-180,250,1,0},{-200,250,1,0},{-220,250,1,0},{-280,250,1,0},{-300,250,1,0}},
/*110*/ {{300,230,1,0},{260,230,1,0},{220,230,1,0},{190,230,1,0},{160,230,1,0},{140,230,1,0},{100,230,1,0},{ 80,230,1,0},{ 60,230,1,0},{ 40,230,1,0},{ 0,230,1,0},{  0,230,1,0},{ -40,230,1,0},{ -60,230,1,0},{ -80,230,1,0},{-100,230,1,0},{-140,230,1,0},{-160,230,1,0},{-190,230,1,0},{-220,230,1,0},{-260,230,1,0},{-300,230,1,0}},
/*120*/ {{280,200,1,0},{250,200,1,0},{200,200,1,0},{170,200,1,0},{150,200,1,0},{120,200,1,0},{100,200,1,0},{ 70,200,1,0},{ 50,200,1,0},{ 30,200,1,0},{ 0,200,1,0},{  0,200,1,0},{ -30,200,1,0},{ -50,200,1,0},{ -70,200,1,0},{-100,200,1,0},{-120,200,1,0},{-150,200,1,0},{-170,200,1,0},{-200,200,1,0},{-250,200,1,0},{-280,200,1,0}},
/*130*/ {{250,180,1,0},{230,180,1,0},{200,180,1,0},{170,180,1,0},{150,180,1,0},{120,180,1,0},{100,180,1,0},{ 70,180,1,0},{ 50,180,1,0},{ 30,180,1,0},{ 0,180,1,0},{  0,180,1,0},{ -30,180,1,0},{ -50,180,1,0},{ -70,180,1,0},{-100,180,1,0},{-120,180,1,0},{-150,180,1,0},{-170,180,1,0},{-200,180,1,0},{-230,180,1,0},{-250,180,1,0}},
/*140*/ {{250,150,1,0},{220,155,1,0},{190,160,1,0},{160,160,1,0},{140,160,1,0},{120,160,1,0},{100,160,1,0},{ 70,160,1,0},{ 50,160,1,0},{ 30,160,1,0},{ 0,160,1,0},{  0,160,1,0},{ -30,160,1,0},{ -50,160,1,0},{ -70,160,1,0},{-100,160,1,0},{-120,160,1,0},{-140,160,1,0},{-160,160,1,0},{-190,160,1,0},{-220,155,1,0},{-250,150,1,0}},
/*150*/ {{250,130,1,0},{210,140,1,0},{180,150,1,0},{160,150,1,0},{140,150,1,0},{120,150,1,0},{100,150,1,0},{ 70,150,1,0},{ 50,150,1,0},{ 30,150,1,0},{ 0,150,1,0},{  0,150,1,0},{ -30,150,1,0},{ -50,150,1,0},{ -70,150,1,0},{-100,150,1,0},{-120,150,1,0},{-140,150,1,0},{-160,150,1,0},{-180,150,1,0},{-210,140,1,0},{-250,130,1,0}},
/*160*/ {{240,120,1,0},{200,130,1,0},{170,130,1,0},{150,130,1,0},{130,130,1,0},{110,130,1,0},{ 90,130,1,0},{ 70,130,1,0},{ 50,130,1,0},{ 30,130,1,0},{ 0,130,1,0},{  0,130,1,0},{ -30,130,1,0},{ -50,130,1,0},{ -70,130,1,0},{ -90,130,1,0},{-110,130,1,0},{-130,130,1,0},{-150,130,1,0},{-170,130,1,0},{-200,130,1,0},{-240,120,1,0}},
/*170*/ {{230,100,1,0},{200,100,1,0},{170,110,1,0},{150,120,1,0},{130,120,1,0},{110,120,1,0},{ 90,120,1,0},{ 70,120,1,0},{ 50,120,1,0},{ 30,120,1,0},{ 0,120,1,0},{  0,120,1,0},{ -30,120,1,0},{ -50,120,1,0},{ -70,120,1,0},{ -90,120,1,0},{-110,120,1,0},{-130,120,1,0},{-150,120,1,0},{-170,110,1,0},{-200,100,1,0},{-230,100,1,0}},
/*180*/ {{210, 80,1,0},{200, 90,1,0},{170,100,1,0},{150,100,1,0},{130,100,1,0},{100,100,1,0},{ 80,100,1,0},{ 60,100,1,0},{ 40,100,1,0},{ 30,100,1,0},{ 0,100,1,0},{  0,100,1,0},{ -30,100,1,0},{ -40,100,1,0},{ -60,100,1,0},{ -80,100,1,0},{-100,100,1,0},{-130,100,1,0},{-150,100,1,0},{-170,100,1,0},{-200, 90,1,0},{-210, 80,1,0}},
/*190*/ {{200, 70,1,0},{180, 80,1,0},{160, 90,1,0},{140, 90,1,0},{120, 90,1,0},{100, 90,1,0},{ 80, 90,1,0},{ 60, 90,1,0},{ 40, 90,1,0},{ 30, 90,1,0},{ 0, 90,1,0},{  0, 90,1,0},{ -30, 90,1,0},{ -40, 90,1,0},{ -60, 90,1,0},{ -80, 90,1,0},{-100, 90,1,0},{-120, 90,1,0},{-140, 90,1,0},{-160, 90,1,0},{-180, 80,1,0},{-200, 70,1,0}},
/*200*/ {{200, 50,1,0},{180, 60,1,0},{160, 70,1,0},{140, 70,1,0},{120, 70,1,0},{100, 70,1,0},{ 80, 70,1,0},{ 60, 70,1,0},{ 40, 70,1,0},{ 30, 70,1,0},{ 0, 70,1,0},{  0, 70,1,0},{ -30, 70,1,0},{ -40, 70,1,0},{ -60, 70,1,0},{ -80, 70,1,0},{-100, 70,1,0},{-120, 70,1,0},{-140, 70,1,0},{-160, 70,1,0},{-180, 60,1,0},{-200, 50,1,0}},
/*210*/ {{200, 50,1,0},{180, 60,1,0},{160, 70,1,0},{140, 70,1,0},{120, 70,1,0},{100, 70,1,0},{ 80, 70,1,0},{ 60, 70,1,0},{ 40, 70,1,0},{ 30, 70,1,0},{ 0, 70,1,0},{  0, 70,1,0},{ -30, 70,1,0},{ -40, 70,1,0},{ -60, 70,1,0},{ -80, 70,1,0},{-100, 70,1,0},{-120, 70,1,0},{-140, 70,1,0},{-160, 70,1,0},{-180, 60,1,0},{-200, 50,1,0}},
};

#endif

static void info_grid_angle_init()
{
    const float EPSINON = 0.00001;
    float flag = 0;
    int i,j;
    for(i=0; i<PIC_H/GRID_SIZE; i++)
    {
        for(j=0; j<PIC_W/GRID_SIZE; j++)
        {
            flag = info_grid[i][j].h;
            if(!((flag >= - EPSINON) && (flag <= EPSINON)))
            {
                if(g_camera_height != INFO_GRID_DEFAULT_HEIGHT)
                {
                    info_grid[i][j].z += (g_camera_height-INFO_GRID_DEFAULT_HEIGHT);
                }
                info_grid[i][j].angle = 90.0 - atan(info_grid[i][j].x / info_grid[i][j].z) * (180.0 / PI);
            }
        }
    }
}

obj_info_t obj_info_get_2(len_t foot_x, len_t foot_y, len_t head_x, len_t head_y)
{
    static char info_grid_init = 0;
    if(!info_grid_init)
    {
        info_grid_angle_init();
        info_grid_init = 1;
    }

    /* use h to check whether the grid is prepared, h!=0 means prepared */
    const float EPSINON = 0.00001;
    float flag = info_grid[(int)(foot_y/GRID_SIZE)][(int)(foot_x/GRID_SIZE)].h;
    if(!((flag >= - EPSINON) && (flag <= EPSINON)))
    {
        return info_grid[(int)(foot_y/GRID_SIZE)][(int)(foot_x/GRID_SIZE)];
    }
    else
    {
        return obj_info_get(foot_x, foot_y, head_x, head_y);
    }
}




